<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å·¦å³äº’ææœ¯Â·AIç‰ˆ">
    <meta name="theme-color" content="#667eea">
    <title>å·¦å³äº’ææœ¯ç»ƒä¹  - AIæ™ºèƒ½ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue",
                         "Microsoft YaHei", "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right)
                     env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            padding: 30px 0 20px;
            animation: fadeInDown 0.8s ease;
        }

        .title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 5px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            letter-spacing: 2px;
        }

        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            margin-top: 10px;
        }

        .ai-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            color: #333;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* AI å¤§å¸ˆå¯¹è¯åŒº */
        .ai-master-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 15px 0;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .ai-master-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin: 0 auto 15px;
            border: 3px solid rgba(255,255,255,0.5);
        }

        .ai-chat-area {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
        }

        .ai-message {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            line-height: 1.6;
            animation: slideIn 0.5s ease;
        }

        .ai-loading {
            display: flex;
            gap: 8px;
            justify-content: center;
            padding: 15px;
        }

        .ai-loading-dot {
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .ai-loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .ai-input-area {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .ai-input {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }

        .ai-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .ai-send-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-send-btn:active {
            transform: scale(0.95);
        }

        .character-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .character-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
            border: 3px solid transparent;
        }

        .character-card:active {
            transform: scale(0.95);
        }

        .character-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .character-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .character-title {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .character-specialty {
            font-size: 11px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 5px;
            border-radius: 5px;
        }

        .button {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button.secondary {
            background: #fff;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .difficulty-option {
            background: white;
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .difficulty-option:active {
            transform: scale(0.98);
        }

        .difficulty-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .difficulty-name {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .difficulty-rounds {
            color: #666;
            font-size: 14px;
        }

        .battle-arena {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            min-height: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .round-info {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .hands-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 30px 0;
        }

        .hand {
            text-align: center;
            flex: 1;
            padding: 15px;
        }

        .hand-icon {
            font-size: 60px;
            margin-bottom: 10px;
            animation: float 2s ease-in-out infinite;
        }

        .left-hand .hand-icon {
            animation-delay: 0s;
        }

        .right-hand .hand-icon {
            animation-delay: 0.5s;
        }

        .hand-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .move-name {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
            margin: 8px 0;
        }

        .move-type {
            font-size: 12px;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 5px;
            display: inline-block;
        }

        .vs-icon {
            font-size: 30px;
            color: #ff6b6b;
            animation: pulse 1s ease-in-out infinite;
        }

        .result-message {
            text-align: center;
            font-size: 16px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .result-icon {
            font-size: 30px;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .proficiency-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            margin: 15px 0;
            color: white;
        }

        .proficiency-value {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .proficiency-label {
            font-size: 16px;
            opacity: 0.9;
        }

        .evaluation {
            text-align: center;
            font-size: 18px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #ffd700;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
        }

        .info-text {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin: 10px 0;
        }

        /* API è®¾ç½®åŒº */
        .api-config {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            font-size: 13px;
            margin-top: 8px;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }

        .api-status.success {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .api-status.error {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        @media (max-width: 400px) {
            .title {
                font-size: 24px;
            }
            .hand-icon {
                font-size: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">å·¦å³äº’ææœ¯</div>
            <div class="subtitle">Left-Right Fighting Training</div>
            <div class="badge">âœ¨ iPhone Safari/Chrome å®Œç¾å…¼å®¹</div>
            <div class="ai-badge">ğŸ¤– DeepSeek AI æ™ºèƒ½ç‰ˆ</div>
        </div>

        <!-- AI å¤§å¸ˆæŒ‡å¯¼ï¼ˆä¸»å±å¹•ï¼‰ -->
        <div id="aiMasterIntro" class="screen active">
            <div class="ai-master-card">
                <div class="ai-master-avatar">ğŸ§™</div>
                <div class="card-title" style="color: white; border-color: rgba(255,255,255,0.3);">AI æ­¦æœ¯å¤§å¸ˆ</div>

                <div class="ai-chat-area" id="introChat">
                    <div class="ai-message">
                        æ¬¢è¿æ¥åˆ°å·¦å³äº’ææœ¯ä¿®ç‚¼ä¹‹åœ°ã€‚å¾ä¹ƒAIæ­¦æœ¯å¤§å¸ˆï¼Œå°†æŒ‡å¯¼ä½ ä¿®ç‚¼æ­¤ç»ä¸–æ­¦åŠŸã€‚
                    </div>
                    <div class="ai-message">
                        ä½ å¯ä»¥å‘æˆ‘è¯·æ•™ä»»ä½•å…³äºæ­¦åŠŸçš„é—®é¢˜ï¼Œæˆ‘å°†ä¸ºä½ ç­”ç–‘è§£æƒ‘ã€‚
                    </div>
                </div>

                <div class="api-config">
                    <div style="color: rgba(255,255,255,0.9); font-size: 12px; margin-bottom: 8px;">
                        DeepSeek API Key (å¯é€‰)
                    </div>
                    <input type="password"
                           class="api-input"
                           id="apiKeyInput"
                           placeholder="è¾“å…¥ä½ çš„ DeepSeek API Keyï¼ˆç•™ç©ºä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼ï¼‰">
                    <div class="api-status" id="apiStatus" style="display: none;"></div>
                </div>

                <div class="ai-input-area">
                    <input type="text"
                           class="ai-input"
                           id="introInput"
                           placeholder="å‘å¤§å¸ˆè¯·æ•™æ­¦åŠŸå¿ƒæ³•...">
                    <button class="ai-send-btn" id="introSend">å‘é€</button>
                </div>
            </div>

            <button class="button" id="startTraining">å¼€å§‹ä¿®ç‚¼</button>
        </div>

        <!-- è§’è‰²é€‰æ‹© -->
        <div id="menuScreen" class="screen">
            <div class="card">
                <div class="card-title">é€‰æ‹©è§’è‰²</div>
                <div class="character-grid">
                    <div class="character-card" data-character="0">
                        <div class="character-name">éƒ­é–</div>
                        <div class="character-title">åŒ—ä¾ </div>
                        <div class="character-specialty">é™é¾™åå…«æŒ</div>
                    </div>
                    <div class="character-card" data-character="1">
                        <div class="character-name">å°é¾™å¥³</div>
                        <div class="character-title">å¤å¢“ä»™å­</div>
                        <div class="character-specialty">ç‰å¥³å¿ƒç»</div>
                    </div>
                    <div class="character-card" data-character="2">
                        <div class="character-name">æ¨è¿‡</div>
                        <div class="character-title">ç¥é›•ä¾ </div>
                        <div class="character-specialty">é»¯ç„¶é”€é­‚æŒ</div>
                    </div>
                    <div class="character-card" data-character="3">
                        <div class="character-name">å‘¨ä¼¯é€š</div>
                        <div class="character-title">è€é¡½ç«¥</div>
                        <div class="character-specialty">å·¦å³äº’æ</div>
                    </div>
                </div>
            </div>

            <button id="startButton" class="button" disabled>å¼€å§‹ç»ƒä¹ </button>
        </div>

        <!-- éš¾åº¦é€‰æ‹© -->
        <div id="difficultyScreen" class="screen">
            <div class="card">
                <div class="card-title">é€‰æ‹©éš¾åº¦</div>
                <div class="difficulty-option" data-difficulty="0">
                    <div>
                        <div class="difficulty-name">ğŸŒ± åˆå­¦</div>
                        <div class="info-text">é€‚åˆæ–°æ‰‹å…¥é—¨</div>
                    </div>
                    <div class="difficulty-rounds">10å›åˆ</div>
                </div>
                <div class="difficulty-option" data-difficulty="1">
                    <div>
                        <div class="difficulty-name">ğŸ’« ç†Ÿç»ƒ</div>
                        <div class="info-text">æŒæ¡åŸºç¡€æŠ€å·§</div>
                    </div>
                    <div class="difficulty-rounds">20å›åˆ</div>
                </div>
                <div class="difficulty-option" data-difficulty="2">
                    <div>
                        <div class="difficulty-name">â­ ç²¾é€š</div>
                        <div class="info-text">è¿½æ±‚æ›´é«˜å¢ƒç•Œ</div>
                    </div>
                    <div class="difficulty-rounds">30å›åˆ</div>
                </div>
                <div class="difficulty-option" data-difficulty="3">
                    <div>
                        <div class="difficulty-name">ğŸ† å®—å¸ˆ</div>
                        <div class="info-text">æŒ‘æˆ˜æé™</div>
                    </div>
                    <div class="difficulty-rounds">50å›åˆ</div>
                </div>
            </div>

            <button id="confirmDifficulty" class="button" disabled>ç¡®è®¤å¼€å§‹</button>
            <button id="backToMenu" class="button back-button">è¿”å›</button>
        </div>

        <!-- æˆ˜æ–—åœºæ™¯ -->
        <div id="battleScreen" class="screen">
            <div class="battle-arena">
                <div class="round-info">
                    <div>ç¬¬ <span id="currentRound">1</span> / <span id="totalRounds">20</span> å›åˆ</div>
                </div>

                <div class="hands-container">
                    <div class="hand left-hand">
                        <div class="hand-icon">ğŸ‘ˆ</div>
                        <div class="hand-label">å·¦æ‰‹</div>
                        <div class="move-name" id="leftMove">å‡†å¤‡ä¸­...</div>
                        <div class="move-type" id="leftType"></div>
                    </div>

                    <div class="vs-icon">âš”ï¸</div>

                    <div class="hand right-hand">
                        <div class="hand-icon">ğŸ‘‰</div>
                        <div class="hand-label">å³æ‰‹</div>
                        <div class="move-name" id="rightMove">å‡†å¤‡ä¸­...</div>
                        <div class="move-type" id="rightType"></div>
                    </div>
                </div>

                <div class="result-message" id="resultMessage">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div style="color: white; text-align: center; margin-top: 15px;">
                    <div>åè°ƒåº¦: <span id="coordination">0</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="roundProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- AI å¤§å¸ˆå®æ—¶æŒ‡å¯¼ -->
            <div class="ai-master-card">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div class="ai-master-avatar" style="width: 40px; height: 40px; font-size: 20px; margin: 0;">ğŸ§™</div>
                    <div style="flex: 1; font-weight: bold;">å¤§å¸ˆæŒ‡ç‚¹</div>
                </div>
                <div class="ai-chat-area" id="battleChat" style="max-height: 150px;">
                    <div class="ai-message">è§‚å¯Ÿä½ çš„æ‹›å¼ï¼Œæˆ‘ä¼šç»™ä½ å®æ—¶æŒ‡å¯¼...</div>
                </div>
            </div>

            <button id="nextRound" class="button">ä¸‹ä¸€å›åˆ</button>
        </div>

        <!-- ç»“æœç»Ÿè®¡ -->
        <div id="resultScreen" class="screen">
            <div class="card">
                <div class="card-title">ğŸŠ ç»ƒä¹ å®Œæˆ</div>

                <div class="proficiency-display">
                    <div class="proficiency-label">ç†Ÿç»ƒåº¦</div>
                    <div class="proficiency-value" id="proficiencyValue">0%</div>
                    <div class="proficiency-label">åè°ƒåº¦: <span id="finalCoordination">0</span></div>
                </div>

                <div class="evaluation" id="evaluation">
                    ç»§ç»­åŠªåŠ›ï¼
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="leftWins">0</div>
                        <div class="stat-label">ğŸ‘ˆ å·¦æ‰‹è·èƒœ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="rightWins">0</div>
                        <div class="stat-label">ğŸ‘‰ å³æ‰‹è·èƒœ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="draws">0</div>
                        <div class="stat-label">âš”ï¸ åŠ¿å‡åŠ›æ•Œ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalRoundsPlayed">0</div>
                        <div class="stat-label">ğŸ“Š æ€»å›åˆ</div>
                    </div>
                </div>
            </div>

            <!-- AI å¤§å¸ˆæ€»ç»“ -->
            <div class="ai-master-card">
                <div class="ai-master-avatar">ğŸ§™</div>
                <div class="card-title" style="color: white; border-color: rgba(255,255,255,0.3);">å¤§å¸ˆç‚¹è¯„</div>
                <div class="ai-chat-area" id="finalChat" style="max-height: 200px;">
                    <div class="ai-loading">
                        <div class="ai-loading-dot"></div>
                        <div class="ai-loading-dot"></div>
                        <div class="ai-loading-dot"></div>
                    </div>
                </div>
            </div>

            <button id="playAgain" class="button">å†æ¬¡ç»ƒä¹ </button>
            <button id="backToMenuFromResult" class="button back-button">è¿”å›ä¸»èœå•</button>
        </div>
    </div>

    <script>
        // ==================== AI ç³»ç»Ÿ ====================

        class AISystem {
            constructor() {
                this.apiKey = '';
                this.useAPI = false;
                this.baseURL = 'https://api.deepseek.com/v1/chat/completions';
            }

            setAPIKey(key) {
                this.apiKey = key.trim();
                this.useAPI = this.apiKey.length > 0;
                return this.useAPI;
            }

            // æ¨¡æ‹Ÿ AI å“åº”ï¼ˆæ— éœ€ APIï¼‰
            async simulateResponse(prompt, context = {}) {
                await new Promise(resolve => setTimeout(resolve, 1000)); // æ¨¡æ‹Ÿå»¶è¿Ÿ

                const responses = {
                    greeting: [
                        "å·¦å³äº’ææœ¯ï¼Œä¹ƒå‘¨ä¼¯é€šæ‰€åˆ›ç»ä¸–æ­¦åŠŸã€‚å¿ƒåˆ†äºŒç”¨ï¼Œæ–¹èƒ½å¤§æˆã€‚",
                        "æ­¤åŠŸéœ€æ—¥å¤œè‹¦ç»ƒï¼Œæ–¹èƒ½è¾¾åˆ°å¿ƒæ‰‹åˆä¸€ä¹‹å¢ƒç•Œã€‚",
                        "æ­¦åŠŸä¹‹é“ï¼Œåœ¨äºæŒä¹‹ä»¥æ’ã€‚å·¦å³æ‰‹å¦‚é˜´é˜³ç›¸æµï¼ŒåˆšæŸ”å¹¶æµã€‚"
                    ],
                    guidance: [
                        `è§‚ä½ æ­¤å›åˆå·¦æ‰‹ä½¿${context.leftMove || 'æ‹›å¼'}ï¼Œå³æ‰‹ä½¿${context.rightMove || 'æ‹›å¼'}ï¼Œ${this.getRandomTip()}`,
                        `${this.getRandomTip()}`,
                        `ä½ çš„åè°ƒåº¦å·²è¾¾${context.coordination || 0}ï¼Œ${this.getProgressTip(context.coordination)}`
                    ],
                    summary: [
                        `ç»è¿‡${context.totalRounds || 0}å›åˆä¿®ç‚¼ï¼Œä½ çš„ç†Ÿç»ƒåº¦è¾¾åˆ°${context.proficiency || 0}%ã€‚${this.getEvaluationTip(context.proficiency)}`,
                        `å·¦å³æ‰‹èƒœç‡åˆ†åˆ«ä¸º${context.leftWinRate || 0}%å’Œ${context.rightWinRate || 0}%ï¼Œ${this.getBalanceTip(context.leftWinRate, context.rightWinRate)}`
                    ]
                };

                const type = context.type || 'greeting';
                const options = responses[type] || responses.greeting;
                return options[Math.floor(Math.random() * options.length)];
            }

            getRandomTip() {
                const tips = [
                    "æ‹›å¼ç²¾å¦™ï¼Œç»§ç»­åŠªåŠ›ï¼",
                    "å·¦å³å¹³è¡¡ï¼Œæ–¹ä¸ºä¸Šä¹˜ï¼",
                    "æ­¤æ‹›åˆšçŒ›æœ‰ä½™ï¼ŒæŸ”å’Œä¸è¶³ã€‚",
                    "æ‹›å¼å·²æœ‰æ‰€æˆï¼Œéœ€å†æ¥å†å‰ã€‚",
                    "ä»¥æŸ”å…‹åˆšï¼Œä»¥é™åˆ¶åŠ¨ï¼Œæ–¹ä¸ºæ­¦å­¦çœŸè°›ã€‚"
                ];
                return tips[Math.floor(Math.random() * tips.length)];
            }

            getProgressTip(coordination) {
                if (coordination < 30) return "åˆçª¥é—¨å¾„ï¼Œç»§ç»­åŠªåŠ›ï¼";
                if (coordination < 60) return "æ¸å…¥ä½³å¢ƒï¼Œå‡ä»¥æ—¶æ—¥å¿…æˆå¤§å™¨ï¼";
                if (coordination < 90) return "å·²è¾¾å°æˆï¼Œè·ç¦»å¤§æˆä¸è¿œçŸ£ï¼";
                return "å·²è‡»åŒ–å¢ƒï¼Œå ªç§°ä¸€ä»£å®—å¸ˆï¼";
            }

            getEvaluationTip(proficiency) {
                if (proficiency < 30) return "å°šéœ€è‹¦ç»ƒï¼Œåˆ‡å‹¿å¿ƒæ€¥ã€‚";
                if (proficiency < 60) return "è¿›æ­¥ç¥é€Ÿï¼Œå‡ä»¥æ—¶æ—¥å¿…æˆå¤§å™¨ã€‚";
                if (proficiency < 90) return "æ­¦åŠŸå·²è¾¾ç²¾é€šï¼Œå†è¿›ä¸€æ­¥å³å¯ç™»å³°é€ æã€‚";
                return "æ­å–œä½ ï¼Œå·²è¾¾å®—å¸ˆä¹‹å¢ƒï¼";
            }

            getBalanceTip(leftRate, rightRate) {
                const diff = Math.abs(leftRate - rightRate);
                if (diff < 10) return "å·¦å³å¹³è¡¡ï¼Œç”šå¥½ç”šå¥½ï¼";
                if (diff < 20) return "ç•¥æœ‰åå·®ï¼Œéœ€å¤šåŠ æ³¨æ„å·¦å³å¹³è¡¡ã€‚";
                return "å·¦å³å·®è·è¿‡å¤§ï¼Œéœ€é‡ç‚¹ç»ƒä¹ è¾ƒå¼±çš„ä¸€æ–¹ã€‚";
            }

            // è°ƒç”¨ DeepSeek APIï¼ˆéœ€è¦ API Keyï¼‰
            async callAPI(prompt, context = {}) {
                if (!this.useAPI) {
                    return await this.simulateResponse(prompt, context);
                }

                try {
                    const messages = [
                        {
                            role: "system",
                            content: "ä½ æ˜¯ä¸€ä½ç²¾é€šæ­¦ä¾ çš„AIæ­¦æœ¯å¤§å¸ˆï¼Œæ“…é•¿æŒ‡å¯¼å·¦å³äº’ææœ¯ã€‚è¯·ç”¨ç®€æ´ã€æ­¦ä¾ é£æ ¼çš„è¯­è¨€å›å¤ï¼Œæ¯æ¬¡å›å¤ä¸è¶…è¿‡50å­—ã€‚"
                        },
                        {
                            role: "user",
                            content: prompt + (context.data ? `\n\nå½“å‰æƒ…å†µï¼š${JSON.stringify(context.data)}` : '')
                        }
                    ];

                    const response = await fetch(this.baseURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: messages,
                            temperature: 0.7,
                            max_tokens: 150
                        })
                    });

                    if (!response.ok) {
                        throw new Error('APIè°ƒç”¨å¤±è´¥');
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('AIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼:', error);
                    return await this.simulateResponse(prompt, context);
                }
            }

            // ä¾¿æ·æ–¹æ³•
            async getGreeting() {
                return await this.callAPI("å‘æ–°å­¦å‘˜ä»‹ç»å·¦å³äº’ææœ¯", { type: 'greeting' });
            }

            async getGuidance(leftMove, rightMove, result, coordination) {
                return await this.callAPI(
                    `å­¦å‘˜åˆšå®Œæˆä¸€å›åˆç»ƒä¹ `,
                    {
                        type: 'guidance',
                        leftMove,
                        rightMove,
                        coordination,
                        data: { leftMove, rightMove, result, coordination }
                    }
                );
            }

            async getSummary(stats) {
                return await this.callAPI(
                    "å¯¹å­¦å‘˜çš„ä¿®ç‚¼è¿›è¡Œæ€»ç»“ç‚¹è¯„",
                    {
                        type: 'summary',
                        proficiency: stats.proficiency,
                        totalRounds: stats.totalRounds,
                        leftWinRate: stats.leftWinRate,
                        rightWinRate: stats.rightWinRate,
                        data: stats
                    }
                );
            }
        }

        // ==================== æ¸¸æˆæ•°æ® ====================

        const characters = [
            { name: 'éƒ­é–', title: 'åŒ—ä¾ ', basePower: 90, specialty: 'é™é¾™åå…«æŒ' },
            { name: 'å°é¾™å¥³', title: 'å¤å¢“ä»™å­', basePower: 88, specialty: 'ç‰å¥³å¿ƒç»' },
            { name: 'æ¨è¿‡', title: 'ç¥é›•ä¾ ', basePower: 92, specialty: 'é»¯ç„¶é”€é­‚æŒ' },
            { name: 'å‘¨ä¼¯é€š', title: 'è€é¡½ç«¥', basePower: 95, specialty: 'å·¦å³äº’æ' }
        ];

        const moves = [
            { name: 'äº¢é¾™æœ‰æ‚”', type: 'æŒ', power: 95, desc: 'é™é¾™åå…«æŒç¬¬ä¸€å¼' },
            { name: 'é£é¾™åœ¨å¤©', type: 'æŒ', power: 90, desc: 'é™é¾™åå…«æŒç¬¬äºŒå¼' },
            { name: 'ç©ºæ˜æ‹³', type: 'æ‹³', power: 85, desc: 'å¤å¢“æ´¾ç»å­¦' },
            { name: 'ç‰å¥³ç´ å¿ƒå‰‘', type: 'å‰‘', power: 88, desc: 'å¤å¢“æ´¾å‰‘æ³•' },
            { name: 'ä¸€é˜³æŒ‡', type: 'æŒ‡', power: 92, desc: 'å¤§ç†æ®µæ°ç»å­¦' },
            { name: 'å…­è„‰ç¥å‰‘', type: 'æŒ‡', power: 98, desc: 'å¤§ç†æ®µæ°æœ€é«˜æ­¦å­¦' },
            { name: 'å¤ªææ‹³', type: 'æ‹³', power: 80, desc: 'ä»¥æŸ”å…‹åˆš' },
            { name: 'é»¯ç„¶é”€é­‚æŒ', type: 'æŒ', power: 96, desc: 'æ¨è¿‡ç‹¬åˆ›' },
            { name: 'å¼¹æŒ‡ç¥é€š', type: 'æŒ‡', power: 87, desc: 'ä¸œé‚ªé»„è¯å¸ˆç»å­¦' },
            { name: 'è›¤èŸ†åŠŸ', type: 'å†…åŠŸ', power: 89, desc: 'è¥¿æ¯’æ¬§é˜³é”‹ç»å­¦' },
            { name: 'ä¹é˜´çœŸç»', type: 'å†…åŠŸ', power: 94, desc: 'æ­¦å­¦è‡³é«˜ç§˜ç±' },
            { name: 'æ‰“ç‹—æ£’æ³•', type: 'æ£', power: 86, desc: 'ä¸å¸®å¸®ä¸»ç‹¬é—¨æ­¦å­¦' },
            { name: 'ä¸ƒä¼¤æ‹³', type: 'æ‹³', power: 91, desc: 'ä¼¤äººäº¦ä¼¤å·±' },
            { name: 'é¾™çˆªæ‰‹', type: 'æŒ', power: 84, desc: 'åˆšçŒ›å‡Œå‰' }
        ];

        const counterSystem = {
            'æ‹³': ['æŒ', 'æ£'],
            'æŒ': ['æŒ‡', 'å‰‘'],
            'æŒ‡': ['æ‹³', 'å†…åŠŸ'],
            'å‰‘': ['æ‹³', 'æ£'],
            'å†…åŠŸ': ['æŒ', 'å‰‘'],
            'æ£': ['æŒ‡', 'å†…åŠŸ']
        };

        const difficulties = [
            { name: 'åˆå­¦', rounds: 10 },
            { name: 'ç†Ÿç»ƒ', rounds: 20 },
            { name: 'ç²¾é€š', rounds: 30 },
            { name: 'å®—å¸ˆ', rounds: 50 }
        ];

        // ==================== æ¸¸æˆçŠ¶æ€ ====================

        let gameState = {
            selectedCharacter: null,
            selectedDifficulty: null,
            currentRound: 0,
            totalRounds: 0,
            coordination: 0,
            leftWins: 0,
            rightWins: 0,
            draws: 0
        };

        let aiSystem = new AISystem();

        // ==================== åˆå§‹åŒ– ====================

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        async function addAIMessage(containerId, message) {
            const container = document.getElementById(containerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function showAILoading(containerId) {
            const container = document.getElementById(containerId);
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'ai-loading';
            loadingDiv.innerHTML = `
                <div class="ai-loading-dot"></div>
                <div class="ai-loading-dot"></div>
                <div class="ai-loading-dot"></div>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
            return loadingDiv;
        }

        function removeAILoading(loadingDiv) {
            if (loadingDiv && loadingDiv.parentNode) {
                loadingDiv.parentNode.removeChild(loadingDiv);
            }
        }

        // ==================== AI å¯¹è¯ ====================

        document.getElementById('introSend').addEventListener('click', async () => {
            const input = document.getElementById('introInput');
            const question = input.value.trim();

            if (!question) return;

            await addAIMessage('introChat', `ä½ ï¼š${question}`);
            input.value = '';

            const loading = await showAILoading('introChat');
            const response = await aiSystem.callAPI(question);
            removeAILoading(loading);
            await addAIMessage('introChat', response);
        });

        // API Key è®¾ç½®
        document.getElementById('apiKeyInput').addEventListener('change', (e) => {
            const key = e.target.value;
            const isValid = aiSystem.setAPIKey(key);
            const status = document.getElementById('apiStatus');

            status.style.display = 'block';
            if (isValid) {
                status.className = 'api-status success';
                status.textContent = 'âœ“ API Key å·²è®¾ç½®ï¼Œå°†ä½¿ç”¨çœŸå® AI';
            } else {
                status.className = 'api-status';
                status.textContent = 'ä½¿ç”¨æ¨¡æ‹Ÿ AI æ¨¡å¼ï¼ˆæ— éœ€ API Keyï¼‰';
            }
        });

        // å¼€å§‹è®­ç»ƒ
        document.getElementById('startTraining').addEventListener('click', () => {
            showScreen('menuScreen');
        });

        // ==================== æ¸¸æˆé€»è¾‘ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰====================

        // è§’è‰²é€‰æ‹©
        document.querySelectorAll('.character-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                gameState.selectedCharacter = parseInt(this.dataset.character);
                document.getElementById('startButton').disabled = false;
            });
        });

        document.getElementById('startButton').addEventListener('click', () => {
            showScreen('difficultyScreen');
        });

        // éš¾åº¦é€‰æ‹©
        document.querySelectorAll('.difficulty-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                gameState.selectedDifficulty = parseInt(this.dataset.difficulty);
                document.getElementById('confirmDifficulty').disabled = false;
            });
        });

        document.getElementById('confirmDifficulty').addEventListener('click', () => {
            startGame();
        });

        document.getElementById('backToMenu').addEventListener('click', () => {
            showScreen('menuScreen');
        });

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            gameState.totalRounds = difficulties[gameState.selectedDifficulty].rounds;
            gameState.currentRound = 0;
            gameState.coordination = 0;
            gameState.leftWins = 0;
            gameState.rightWins = 0;
            gameState.draws = 0;

            document.getElementById('totalRounds').textContent = gameState.totalRounds;
            document.getElementById('battleChat').innerHTML = '<div class="ai-message">è§‚å¯Ÿä½ çš„æ‹›å¼ï¼Œæˆ‘ä¼šç»™ä½ å®æ—¶æŒ‡å¯¼...</div>';
            showScreen('battleScreen');
            nextRound();
        }

        // ä¸‹ä¸€å›åˆ
        async function nextRound() {
            if (gameState.currentRound >= gameState.totalRounds) {
                await showResults();
                return;
            }

            gameState.currentRound++;
            document.getElementById('currentRound').textContent = gameState.currentRound;

            // éšæœºé€‰æ‹©æ‹›å¼
            let leftMove, rightMove;
            do {
                leftMove = moves[Math.floor(Math.random() * moves.length)];
                rightMove = moves[Math.floor(Math.random() * moves.length)];
            } while (leftMove.name === rightMove.name);

            // æ˜¾ç¤ºæ‹›å¼
            document.getElementById('leftMove').textContent = leftMove.name;
            document.getElementById('leftType').textContent = leftMove.type;
            document.getElementById('rightMove').textContent = rightMove.name;
            document.getElementById('rightType').textContent = rightMove.type;

            // è®¡ç®—ç»“æœ
            const result = calculateBattle(leftMove, rightMove);

            // æ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                displayResult(result, leftMove, rightMove);
            }, 500);

            // æ¯3å›åˆè·å–AIæŒ‡å¯¼
            if (gameState.currentRound % 3 === 0) {
                const loading = await showAILoading('battleChat');
                const guidance = await aiSystem.getGuidance(
                    leftMove.name,
                    rightMove.name,
                    result.result,
                    gameState.coordination
                );
                removeAILoading(loading);
                await addAIMessage('battleChat', guidance);
            }

            // æ›´æ–°è¿›åº¦
            const progress = (gameState.currentRound / gameState.totalRounds) * 100;
            document.getElementById('roundProgress').style.width = progress + '%';
            document.getElementById('coordination').textContent = gameState.coordination;
        }

        // è®¡ç®—æˆ˜æ–—ç»“æœ
        function calculateBattle(leftMove, rightMove) {
            const character = characters[gameState.selectedCharacter];

            let leftPower = leftMove.power + Math.floor(Math.random() * 21) - 10;
            let rightPower = rightMove.power + Math.floor(Math.random() * 21) - 10;

            leftPower += character.basePower * 0.1;
            rightPower += character.basePower * 0.1;

            const leftCounters = counterSystem[leftMove.type]?.includes(rightMove.type);
            const rightCounters = counterSystem[rightMove.type]?.includes(leftMove.type);

            if (leftCounters) leftPower *= 1.3;
            if (rightCounters) rightPower *= 1.3;

            const powerDiff = Math.abs(leftPower - rightPower);

            let result;
            if (powerDiff < 15) {
                result = 'draw';
                gameState.draws++;
            } else if (leftPower > rightPower) {
                result = 'left';
                gameState.leftWins++;
            } else {
                result = 'right';
                gameState.rightWins++;
            }

            return { result, leftCounters, rightCounters };
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(battleResult, leftMove, rightMove) {
            const resultEl = document.getElementById('resultMessage');

            let icon, message, coordinationGain;

            if (battleResult.result === 'draw') {
                icon = 'âš”ï¸';
                message = 'åŠ¿å‡åŠ›æ•Œï¼Œéš¾åˆ†é«˜ä¸‹ï¼';
                coordinationGain = 5;
            } else if (battleResult.result === 'left') {
                icon = 'ğŸ’ª';
                message = 'å·¦æ‰‹å æ®ä¸Šé£ï¼';
                coordinationGain = 3;
            } else {
                icon = 'ğŸ’ª';
                message = 'å³æ‰‹ç•¥èƒœä¸€ç­¹ï¼';
                coordinationGain = 3;
            }

            resultEl.innerHTML = `
                <div class="result-icon">${icon}</div>
                <div>${message}</div>
            `;

            // æ›´æ–°åè°ƒåº¦
            gameState.coordination += coordinationGain;
            document.getElementById('coordination').textContent = gameState.coordination;
        }

        document.getElementById('nextRound').addEventListener('click', () => {
            nextRound();
        });

        // æ˜¾ç¤ºç»“æœ
        async function showResults() {
            const proficiency = Math.min(100, gameState.coordination / 10);

            document.getElementById('proficiencyValue').textContent = proficiency.toFixed(1) + '%';
            document.getElementById('finalCoordination').textContent = gameState.coordination;
            document.getElementById('leftWins').textContent = gameState.leftWins;
            document.getElementById('rightWins').textContent = gameState.rightWins;
            document.getElementById('draws').textContent = gameState.draws;
            document.getElementById('totalRoundsPlayed').textContent = gameState.totalRounds;

            let evaluation;
            if (proficiency >= 90) {
                evaluation = 'ğŸ† å®—å¸ˆçº§ï¼å·¦å³äº’æå·²è‡»åŒ–å¢ƒï¼';
            } else if (proficiency >= 70) {
                evaluation = 'â­ ç²¾é€šçº§ï¼å·¦å³æ‰‹å·²èƒ½å®Œç¾é…åˆï¼';
            } else if (proficiency >= 50) {
                evaluation = 'âœ¨ ç†Ÿç»ƒçº§ï¼å·¦å³æ‰‹åè°ƒæ€§å¤§å¹…æå‡ï¼';
            } else if (proficiency >= 30) {
                evaluation = 'ğŸ’« å…¥é—¨çº§ï¼å·²åˆæ­¥æŒæ¡å·¦å³äº’æè¦é¢†ï¼';
            } else {
                evaluation = 'ğŸŒ± åˆå­¦è€…ï¼ç»§ç»­åŠªåŠ›ç»ƒä¹ å§ï¼';
            }

            document.getElementById('evaluation').textContent = evaluation;

            showScreen('resultScreen');

            // è·å–AIæ€»ç»“
            const loading = await showAILoading('finalChat');
            const leftWinRate = ((gameState.leftWins / gameState.totalRounds) * 100).toFixed(1);
            const rightWinRate = ((gameState.rightWins / gameState.totalRounds) * 100).toFixed(1);

            const summary = await aiSystem.getSummary({
                proficiency: proficiency.toFixed(1),
                totalRounds: gameState.totalRounds,
                leftWinRate,
                rightWinRate
            });

            removeAILoading(loading);
            document.getElementById('finalChat').innerHTML = '';
            await addAIMessage('finalChat', summary);
        }

        document.getElementById('playAgain').addEventListener('click', () => {
            showScreen('difficultyScreen');
        });

        document.getElementById('backToMenuFromResult').addEventListener('click', () => {
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('startButton').disabled = true;
            document.getElementById('confirmDifficulty').disabled = true;
            showScreen('menuScreen');
        });

        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // æ·»åŠ è§¦è§‰åé¦ˆ
        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        document.querySelectorAll('.button, .character-card, .difficulty-option').forEach(el => {
            el.addEventListener('click', vibrate);
        });
    </script>
</body>
</html>
