<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="åŸºäº TensorFlow.js çš„æ™ºèƒ½ç‰©å“è¯†åˆ«ç³»ç»Ÿï¼Œæ”¯æŒå›¾ç‰‡ä¸Šä¼ å’Œå®æ—¶æ‘„åƒå¤´æ£€æµ‹ï¼Œå¯è¯†åˆ«80ç§å¸¸è§ç‰©å“">
    <meta name="keywords" content="ç‰©å“è¯†åˆ«,AIè¯†åˆ«,TensorFlow.js,æœºå™¨å­¦ä¹ ,ç‰©ä½“æ£€æµ‹,COCO-SSD">

    <!-- iOS Safari ä¼˜åŒ– -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç‰©å“è¯†åˆ«">
    <meta name="format-detection" content="telephone=no">

    <title>ç‰©å“è¯†åˆ«ç³»ç»Ÿ - Object Recognition System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            /* iOS Safari ä¼˜åŒ– */
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        /* iOS Safari æŒ‰é’®ä¼˜åŒ– */
        button, input[type="file"] + label {
            -webkit-appearance: none;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            cursor: pointer;
            touch-action: manipulation;
        }

        /* é˜²æ­¢iOS Safariæ©¡çš®ç­‹æ•ˆæœ */
        body, html {
            overflow-x: hidden;
            position: relative;
        }

        /* è§†é¢‘å…ƒç´ åœ¨iOSä¸Šçš„ä¼˜åŒ– */
        video {
            -webkit-playsinline: true;
            playsinline: true;
        }

        /* è§¦æ‘¸ä¼˜åŒ– */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        /* iOSè¾“å…¥æ¡†ä¼˜åŒ– */
        input[type="file"] {
            -webkit-appearance: none;
        }
        .prediction-box {
            position: absolute;
            border: 3px solid #10B981;
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .prediction-label {
            position: absolute;
            background: #10B981;
            color: white;
            padding: 4px 8px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #videoCanvas {
            max-width: 100%;
            height: auto;
        }

        /* å…¨å±åŠ è½½åŠ¨ç”» */
        #initialLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #initialLoader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loader-content {
            text-align: center;
            color: white;
        }

        .brain-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            position: relative;
            animation: pulse 2s ease-in-out infinite;
        }

        .brain-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .loader-text {
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .loader-subtext {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
        }

        .progress-bar-container {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin: 30px auto 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: progress 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        @keyframes progress {
            0% {
                width: 0%;
            }
            50% {
                width: 70%;
            }
            100% {
                width: 100%;
            }
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- å…¨å±åŠ è½½åŠ¨ç”» -->
    <div id="initialLoader">
        <div class="loader-content">
            <div class="brain-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke-linejoin="round"/>
                    <path d="M2 17L12 22L22 17" stroke-linejoin="round"/>
                    <path d="M2 12L12 17L22 12" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="loader-text">æ™ºèƒ½ç‰©å“è¯†åˆ«ç³»ç»Ÿ</div>
            <div class="loader-subtext">æ­£åœ¨åŠ è½½ AI æ¨¡å‹...</div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
                ğŸ” æ™ºèƒ½ç‰©å“è¯†åˆ«ç³»ç»Ÿ
            </h1>
            <p class="text-gray-600 mt-2">åŸºäº TensorFlow.js çš„å®æ—¶ç‰©ä½“æ£€æµ‹</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- æ¨¡å‹åŠ è½½çŠ¶æ€ -->
        <div id="loadingSection" class="bg-white rounded-lg shadow-lg p-8 text-center mb-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-700 text-lg font-semibold">æ­£åœ¨åŠ è½½ AI æ¨¡å‹...</p>
            <p class="text-gray-500 text-sm mt-2">é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</p>
        </div>

        <!-- ä¸»è¦åŠŸèƒ½åŒº -->
        <div id="mainSection" class="hidden">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">é€‰æ‹©è¯†åˆ«æ–¹å¼</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ä¸Šä¼ å›¾ç‰‡ -->
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center hover:border-blue-500 transition duration-300">
                        <div class="mb-4">
                            <svg class="mx-auto h-16 w-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">ä¸Šä¼ å›¾ç‰‡</h3>
                        <p class="text-gray-600 text-sm mb-4">æ”¯æŒ JPG, PNG, GIF æ ¼å¼</p>
                        <input type="file" id="imageUpload" accept="image/*" class="hidden">
                        <label for="imageUpload" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg cursor-pointer transition duration-300">
                            é€‰æ‹©å›¾ç‰‡
                        </label>
                    </div>

                    <!-- ä½¿ç”¨æ‘„åƒå¤´ -->
                    <div class="border-2 border-dashed border-green-300 rounded-lg p-8 text-center hover:border-green-500 transition duration-300">
                        <div class="mb-4">
                            <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">å®æ—¶æ‘„åƒå¤´</h3>
                        <p class="text-gray-600 text-sm mb-4">å¼€å¯æ‘„åƒå¤´è¿›è¡Œå®æ—¶æ£€æµ‹</p>
                        <button id="enableCamera" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                            å¯åŠ¨æ‘„åƒå¤´
                        </button>
                        <button id="stopCamera" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                            åœæ­¢æ‘„åƒå¤´
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">è¯†åˆ«ç»“æœ</h2>

                <!-- å›¾ç‰‡æ˜¾ç¤ºåŒº -->
                <div id="imageContainer" class="relative mb-6 hidden">
                    <canvas id="canvas" class="mx-auto border-2 border-gray-300 rounded-lg"></canvas>
                </div>

                <!-- æ‘„åƒå¤´æ˜¾ç¤ºåŒº -->
                <div id="cameraContainer" class="relative mb-6 hidden">
                    <video id="webcam" autoplay playsinline webkit-playsinline muted class="mx-auto border-2 border-gray-300 rounded-lg"></video>
                    <canvas id="videoCanvas" class="absolute top-0 left-0 pointer-events-none"></canvas>
                </div>

                <!-- ç»“æœåˆ—è¡¨ -->
                <div id="resultsContainer" class="hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">æ£€æµ‹åˆ°çš„ç‰©å“ï¼š</h3>
                    <div id="resultsList" class="space-y-3"></div>
                </div>

                <!-- æ— ç»“æœæç¤º -->
                <div id="noResults" class="text-center py-12 text-gray-400">
                    <svg class="mx-auto h-24 w-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-lg">ä¸Šä¼ å›¾ç‰‡æˆ–å¯åŠ¨æ‘„åƒå¤´å¼€å§‹è¯†åˆ«</p>
                </div>
            </div>

            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div class="bg-blue-50 rounded-lg p-6 mt-8">
                <h3 class="text-lg font-semibold mb-3 text-blue-900">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                <ul class="space-y-2 text-blue-800">
                    <li>âœ“ è¯¥ç³»ç»Ÿä½¿ç”¨ COCO-SSD æ¨¡å‹ï¼Œå¯è¯†åˆ« 80 ç§å¸¸è§ç‰©å“</li>
                    <li>âœ“ åŒ…æ‹¬ï¼šäººã€åŠ¨ç‰©ã€è½¦è¾†ã€å®¶å…·ã€é£Ÿç‰©ã€ç”µå­è®¾å¤‡ç­‰</li>
                    <li>âœ“ ç½®ä¿¡åº¦è¶Šé«˜ï¼Œè¯†åˆ«ç»“æœè¶Šå‡†ç¡®ï¼ˆé€šå¸¸ > 0.5 è¾ƒå¯é ï¼‰</li>
                    <li>âœ“ å®æ—¶æ£€æµ‹æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¼šæŒç»­åˆ†ææ‘„åƒå¤´ç”»é¢</li>
                    <li>âœ“ æ‰€æœ‰å¤„ç†å‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œä¸ä¼šä¸Šä¼ æ‚¨çš„å›¾ç‰‡</li>
                </ul>
            </div>

            <!-- æµè§ˆå™¨å…¼å®¹æ€§è¯´æ˜ -->
            <div class="bg-green-50 rounded-lg p-6 mt-4">
                <h3 class="text-lg font-semibold mb-3 text-green-900">ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-green-800">
                    <div>
                        <p class="font-semibold mb-2">å®Œå…¨æ”¯æŒï¼š</p>
                        <ul class="space-y-1">
                            <li>â€¢ Chrome 90+ / Edge 90+</li>
                            <li>â€¢ Firefox 88+</li>
                            <li>â€¢ Safari 14+</li>
                            <li>â€¢ Opera 76+</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">æŠ€æœ¯è¦æ±‚ï¼š</p>
                        <ul class="space-y-1">
                            <li>â€¢ æ”¯æŒ WebGLï¼ˆGPU åŠ é€Ÿï¼‰</li>
                            <li>â€¢ æ”¯æŒ Canvas API</li>
                            <li>â€¢ æ”¯æŒ ES6+ JavaScript</li>
                            <li>â€¢ æ‘„åƒå¤´éœ€æµè§ˆå™¨æƒé™</li>
                        </ul>
                    </div>
                </div>
                <p class="text-xs text-green-700 mt-3">
                    ğŸ’¡ æç¤ºï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æµè§ˆå™¨å…¼å®¹æ€§å¹¶æä¾›ç›¸åº”æç¤ºã€‚å¦‚é‡é—®é¢˜ï¼Œè¯·æ›´æ–°æµè§ˆå™¨æˆ–æ¢ç”¨æ¨èæµè§ˆå™¨ã€‚
                </p>
            </div>

            <!-- iPhone/ç§»åŠ¨ç«¯è®¿é—®æŒ‡å— -->
            <div class="bg-purple-50 rounded-lg p-6 mt-4">
                <h3 class="text-lg font-semibold mb-3 text-purple-900">ğŸ“± iPhone/ç§»åŠ¨ç«¯è®¿é—®æŒ‡å—</h3>
                <div class="text-sm text-purple-800 space-y-4">
                    <div>
                        <p class="font-semibold mb-2">âœ… æ”¯æŒæ‰€æœ‰ç§»åŠ¨æµè§ˆå™¨</p>
                        <p class="text-xs mb-2">ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶é€‚é…æ‰€æœ‰ç§»åŠ¨æµè§ˆå™¨ï¼ŒåŒ…æ‹¬ï¼š</p>
                        <div class="grid grid-cols-2 gap-2 text-xs mt-2 mb-2">
                            <div>â€¢ Safari (iOS)</div>
                            <div>â€¢ Chrome (iOS/Android)</div>
                            <div>â€¢ Firefox (iOS/Android)</div>
                            <div>â€¢ Edge (iOS/Android)</div>
                            <div>â€¢ Samsung Internet</div>
                            <div>â€¢ UC Browser</div>
                            <div>â€¢ QQ Browser</div>
                            <div>â€¢ Opera</div>
                        </div>
                        <p class="text-xs text-purple-700 bg-white bg-opacity-50 p-2 rounded">
                            ğŸ’¡ <strong>è‡ªåŠ¨é€‚é…ï¼š</strong>æ— è®ºæ‚¨ä½¿ç”¨å“ªä¸ªæµè§ˆå™¨æ‰“å¼€é“¾æ¥ï¼Œç³»ç»Ÿéƒ½ä¼šè‡ªåŠ¨è°ƒæ•´ä»¥æä¾›æœ€ä½³ä½“éªŒï¼
                        </p>
                    </div>

                    <div class="bg-white bg-opacity-50 rounded p-3">
                        <p class="font-semibold mb-2">ğŸ“ å¦‚ä½•åœ¨ iPhone ä¸Šè®¿é—®ï¼š</p>
                        <ol class="list-decimal list-inside space-y-1 text-xs">
                            <li>ç¡®ä¿ iPhone å’Œç”µè„‘åœ¨åŒä¸€ WiFi ç½‘ç»œ</li>
                            <li>åœ¨ç”µè„‘ä¸Šè¿è¡ŒæœåŠ¡å™¨ï¼ˆå·²è¿è¡Œåœ¨ç«¯å£ 8080ï¼‰</li>
                            <li>è·å–ç”µè„‘çš„ IP åœ°å€</li>
                            <li>åœ¨<strong>ä»»æ„æµè§ˆå™¨</strong>ä¸­ç²˜è´´é“¾æ¥ï¼š<code class="bg-purple-200 px-1 rounded">http://ç”µè„‘IP:8080</code></li>
                            <li>ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶ä¼˜åŒ–ï¼ˆ8ç§’åæ˜¾ç¤ºæµè§ˆå™¨å¾½ç« ï¼‰</li>
                            <li>ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"æ—¶å…è®¸æµè§ˆå™¨è®¿é—®æ‘„åƒå¤´</li>
                        </ol>
                        <p class="text-xs mt-2 bg-yellow-100 p-2 rounded">
                            ğŸŒŸ <strong>æ”¯æŒæ‰€æœ‰æµè§ˆå™¨ï¼š</strong>Safariã€Chromeã€Firefoxã€Edgeç­‰éƒ½å¯ä»¥ï¼åªéœ€ç²˜è´´é“¾æ¥ï¼Œç³»ç»Ÿè‡ªåŠ¨é€‚é…ï¼
                        </p>
                    </div>

                    <div class="bg-white bg-opacity-50 rounded p-3">
                        <p class="font-semibold mb-2">ğŸ¯ iOS ä¼˜åŒ–ç‰¹æ€§ï¼š</p>
                        <ul class="space-y-1 text-xs">
                            <li>âœ“ è‡ªåŠ¨ä½¿ç”¨åç½®æ‘„åƒå¤´ï¼ˆæ›´é€‚åˆç‰©å“è¯†åˆ«ï¼‰</li>
                            <li>âœ“ è§¦æ‘¸æ“ä½œä¼˜åŒ–ï¼Œæ— ç‚¹å‡»å»¶è¿Ÿ</li>
                            <li>âœ“ è§†é¢‘å†…è”æ’­æ”¾ï¼ˆä¸ä¼šå…¨å±ï¼‰</li>
                            <li>âœ“ å“åº”å¼ç•Œé¢ï¼Œé€‚é…å„ç§å±å¹•</li>
                            <li>âœ“ é˜²æ­¢æ„å¤–ç¼©æ”¾å’Œæ©¡çš®ç­‹æ•ˆæœ</li>
                        </ul>
                    </div>

                    <div>
                        <p class="font-semibold mb-2">âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</p>
                        <ul class="space-y-1 text-xs">
                            <li>â€¢ é¦–æ¬¡ä½¿ç”¨éœ€å…è®¸æµè§ˆå™¨è®¿é—®æ‘„åƒå¤´æƒé™</li>
                            <li>â€¢ å»ºè®®ä½¿ç”¨ iOS 14+ ä»¥è·å¾—æœ€ä½³ä½“éªŒ</li>
                            <li>â€¢ å®æ—¶æ£€æµ‹åŠŸèƒ½è¾ƒè€—ç”µï¼Œå»ºè®®è¿æ¥å……ç”µå™¨</li>
                            <li>â€¢ å¦‚æ‘„åƒå¤´æ— æ³•å¯åŠ¨ï¼Œå°è¯•åˆ·æ–°é¡µé¢æˆ–é‡å¯ Safari</li>
                        </ul>
                    </div>

                    <div class="bg-blue-100 rounded p-2 text-xs">
                        <p class="font-semibold text-blue-900">ğŸ’¡ å¿«é€Ÿæµ‹è¯•ï¼š</p>
                        <p class="text-blue-800">å¦‚æœæ‚¨ç°åœ¨å°±åœ¨ iPhone ä¸ŠæŸ¥çœ‹æ­¤é¡µé¢ï¼Œç›´æ¥ç‚¹å‡»ä¸Šæ–¹çš„"ä¸Šä¼ å›¾ç‰‡"æˆ–"å¯åŠ¨æ‘„åƒå¤´"å³å¯å¼€å§‹ä½¿ç”¨ï¼</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white mt-12 py-6 shadow-md">
        <div class="container mx-auto px-6 text-center text-gray-600">
            <p>åŸºäº TensorFlow.js å’Œ COCO-SSD æ¨¡å‹æ„å»º | æœ¬åœ°å¤„ç†ï¼Œä¿æŠ¤éšç§</p>
        </div>
    </footer>

    <script>
        // ========================================
        // æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹å’ŒPolyfills
        // ========================================

        // å¢å¼ºçš„æµè§ˆå™¨æ£€æµ‹ - æ”¯æŒæ‰€æœ‰ç§»åŠ¨ç«¯æµè§ˆå™¨
        function detectBrowser() {
            const ua = navigator.userAgent;
            const platform = navigator.platform;
            let browserName = "Unknown";
            let browserVersion = "Unknown";
            let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            let isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
            let isAndroid = /Android/i.test(ua);

            // è¯¦ç»†çš„ç§»åŠ¨æµè§ˆå™¨æ£€æµ‹
            if (isIOS) {
                // iOS è®¾å¤‡ä¸Šçš„æµè§ˆå™¨æ£€æµ‹
                if (/CriOS/i.test(ua)) {
                    browserName = "Chrome for iOS";
                    browserVersion = ua.match(/CriOS\/(\d+)/)?.[1] || "Unknown";
                } else if (/FxiOS/i.test(ua)) {
                    browserName = "Firefox for iOS";
                    browserVersion = ua.match(/FxiOS\/(\d+)/)?.[1] || "Unknown";
                } else if (/EdgiOS/i.test(ua)) {
                    browserName = "Edge for iOS";
                    browserVersion = ua.match(/EdgiOS\/(\d+)/)?.[1] || "Unknown";
                } else if (/OPiOS/i.test(ua)) {
                    browserName = "Opera for iOS";
                    browserVersion = ua.match(/OPiOS\/(\d+)/)?.[1] || "Unknown";
                } else if (/Safari/i.test(ua)) {
                    browserName = "Safari (iOS)";
                    browserVersion = ua.match(/Version\/(\d+)/)?.[1] || "Unknown";
                } else {
                    browserName = "iOS WebView";
                    browserVersion = "Unknown";
                }
            } else if (isAndroid) {
                // Android è®¾å¤‡ä¸Šçš„æµè§ˆå™¨æ£€æµ‹
                if (/Chrome/i.test(ua) && !/Edg/i.test(ua)) {
                    browserName = "Chrome for Android";
                    browserVersion = ua.match(/Chrome\/(\d+)/)?.[1] || "Unknown";
                } else if (/Firefox/i.test(ua)) {
                    browserName = "Firefox for Android";
                    browserVersion = ua.match(/Firefox\/(\d+)/)?.[1] || "Unknown";
                } else if (/Edg/i.test(ua)) {
                    browserName = "Edge for Android";
                    browserVersion = ua.match(/Edg\/(\d+)/)?.[1] || "Unknown";
                } else if (/SamsungBrowser/i.test(ua)) {
                    browserName = "Samsung Internet";
                    browserVersion = ua.match(/SamsungBrowser\/(\d+)/)?.[1] || "Unknown";
                } else if (/UCBrowser/i.test(ua)) {
                    browserName = "UC Browser";
                    browserVersion = ua.match(/UCBrowser\/(\d+)/)?.[1] || "Unknown";
                } else if (/MQQBrowser/i.test(ua)) {
                    browserName = "QQ Browser";
                    browserVersion = ua.match(/MQQBrowser\/(\d+)/)?.[1] || "Unknown";
                } else if (/MiuiBrowser/i.test(ua)) {
                    browserName = "MIUI Browser";
                    browserVersion = ua.match(/MiuiBrowser\/(\d+)/)?.[1] || "Unknown";
                } else {
                    browserName = "Android WebView";
                    browserVersion = "Unknown";
                }
            } else {
                // æ¡Œé¢æµè§ˆå™¨æ£€æµ‹
                if (ua.indexOf("Chrome") > -1 && ua.indexOf("Edg") === -1) {
                    browserName = "Chrome";
                    browserVersion = ua.match(/Chrome\/(\d+)/)?.[1] || "Unknown";
                } else if (ua.indexOf("Safari") > -1 && ua.indexOf("Chrome") === -1) {
                    browserName = "Safari";
                    browserVersion = ua.match(/Version\/(\d+)/)?.[1] || "Unknown";
                } else if (ua.indexOf("Firefox") > -1) {
                    browserName = "Firefox";
                    browserVersion = ua.match(/Firefox\/(\d+)/)?.[1] || "Unknown";
                } else if (ua.indexOf("Edg") > -1) {
                    browserName = "Edge";
                    browserVersion = ua.match(/Edg\/(\d+)/)?.[1] || "Unknown";
                } else if (ua.indexOf("MSIE") > -1 || ua.indexOf("Trident") > -1) {
                    browserName = "IE";
                    browserVersion = ua.match(/(?:MSIE |rv:)(\d+)/)?.[1] || "Unknown";
                }
            }

            return {
                name: browserName,
                version: parseInt(browserVersion) || 0,
                isMobile: isMobile,
                isIOS: isIOS,
                isAndroid: isAndroid,
                fullUA: ua
            };
        }

        // è‡ªé€‚åº”æµè§ˆå™¨é…ç½®
        function getAdaptiveConfig(browser) {
            const config = {
                useBackCamera: true,
                videoConstraints: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                needsPlayClick: false,
                supportsInlineVideo: true,
                requiresMuted: false,
                useWebGL: true,
                optimizeForMobile: browser.isMobile
            };

            // iOS ç‰¹æ®Šé…ç½®
            if (browser.isIOS) {
                config.requiresMuted = true; // iOS éœ€è¦é™éŸ³æ‰èƒ½è‡ªåŠ¨æ’­æ”¾
                config.videoConstraints.facingMode = 'environment'; // ä¼˜å…ˆåç½®æ‘„åƒå¤´

                // iOS Safari ç‰¹æ®Šå¤„ç†
                if (browser.name.includes("Safari")) {
                    config.supportsInlineVideo = browser.version >= 10;
                }

                // iOS Chrome/Firefox éœ€è¦ç‰¹æ®Šå¤„ç†
                if (browser.name.includes("Chrome") || browser.name.includes("Firefox")) {
                    config.needsPlayClick = false; // è¿™äº›æµè§ˆå™¨åœ¨iOSä¸Šè¡Œä¸ºç±»ä¼¼Safari
                }
            }

            // Android ç‰¹æ®Šé…ç½®
            if (browser.isAndroid) {
                config.videoConstraints.facingMode = 'environment';

                // UC/QQ æµè§ˆå™¨å¯èƒ½éœ€è¦é™çº§
                if (browser.name.includes("UC") || browser.name.includes("QQ")) {
                    config.videoConstraints = {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    };
                }
            }

            // ç§»åŠ¨è®¾å¤‡é€šç”¨ä¼˜åŒ–
            if (browser.isMobile) {
                // é™ä½è§†é¢‘åˆ†è¾¨ç‡ä»¥æå‡æ€§èƒ½
                if (config.videoConstraints.width.ideal > 1280) {
                    config.videoConstraints.width.ideal = 1280;
                    config.videoConstraints.height.ideal = 720;
                }
            }

            return config;
        }

        // å…¨å±€é…ç½®
        let browserInfo = null;
        let adaptiveConfig = null;

        // æ£€æµ‹æµè§ˆå™¨ä¿¡æ¯

        // getUserMedia API å…¼å®¹æ€§å¤„ç†
        (function() {
            if (navigator.mediaDevices === undefined) {
                navigator.mediaDevices = {};
            }

            if (navigator.mediaDevices.getUserMedia === undefined) {
                navigator.mediaDevices.getUserMedia = function(constraints) {
                    // å°è¯•ä½¿ç”¨æ—§ç‰ˆAPI
                    const getUserMedia = navigator.getUserMedia ||
                                       navigator.webkitGetUserMedia ||
                                       navigator.mozGetUserMedia ||
                                       navigator.msGetUserMedia;

                    if (!getUserMedia) {
                        return Promise.reject(new Error('getUserMedia åœ¨æ­¤æµè§ˆå™¨ä¸­ä¸æ”¯æŒ'));
                    }

                    return new Promise(function(resolve, reject) {
                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                };
            }
        })();

        // requestAnimationFrame å…¼å®¹æ€§å¤„ç†
        (function() {
            const vendors = ['webkit', 'moz', 'ms', 'o'];
            let lastTime = 0;

            for (let x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||
                                             window[vendors[x] + 'CancelRequestAnimationFrame'];
            }

            if (!window.requestAnimationFrame) {
                window.requestAnimationFrame = function(callback) {
                    const currTime = new Date().getTime();
                    const timeToCall = Math.max(0, 16 - (currTime - lastTime));
                    const id = window.setTimeout(function() {
                        callback(currTime + timeToCall);
                    }, timeToCall);
                    lastTime = currTime + timeToCall;
                    return id;
                };
            }

            if (!window.cancelAnimationFrame) {
                window.cancelAnimationFrame = function(id) {
                    clearTimeout(id);
                };
            }
        })();

        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        function checkBrowserCompatibility() {
            const browser = detectBrowser();
            const issues = [];

            // ä¿å­˜åˆ°å…¨å±€å˜é‡
            browserInfo = browser;
            adaptiveConfig = getAdaptiveConfig(browser);

            // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
            const browserLabel = browser.isMobile ?
                `${browser.name} (${browser.isIOS ? 'iOS' : browser.isAndroid ? 'Android' : 'ç§»åŠ¨è®¾å¤‡'})` :
                browser.name;

            console.log(`%cğŸŒ æµè§ˆå™¨æ£€æµ‹`, 'color: #3B82F6; font-size: 14px; font-weight: bold;');
            console.log(`åç§°: ${browserLabel}`);
            console.log(`ç‰ˆæœ¬: ${browser.version}`);
            console.log(`ç§»åŠ¨è®¾å¤‡: ${browser.isMobile ? 'æ˜¯' : 'å¦'}`);
            console.log(`è‡ªé€‚åº”é…ç½®:`, adaptiveConfig);

            // æ£€æŸ¥IEæµè§ˆå™¨
            if (browser.name === "IE") {
                issues.push("Internet Explorer ä¸æ”¯æŒæœ¬åº”ç”¨æ‰€éœ€çš„ç°ä»£WebæŠ€æœ¯");
            }

            // æ£€æŸ¥Canvasæ”¯æŒ
            const canvas = document.createElement('canvas');
            if (!canvas.getContext || !canvas.getContext('2d')) {
                issues.push("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Canvas API");
            }

            // æ£€æŸ¥WebGLæ”¯æŒï¼ˆTensorFlow.jséœ€è¦ï¼‰
            try {
                const testCanvas = document.createElement('canvas');
                const gl = testCanvas.getContext('webgl') || testCanvas.getContext('experimental-webgl');
                if (!gl) {
                    issues.push("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ WebGLï¼ˆAIæ¨¡å‹è¿è¡Œéœ€è¦ï¼‰");
                }
            } catch (e) {
                issues.push("WebGL åˆå§‹åŒ–å¤±è´¥");
            }

            // æ£€æŸ¥FileReaderæ”¯æŒ
            if (!window.FileReader) {
                issues.push("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶è¯»å–åŠŸèƒ½");
            }

            // æ£€æŸ¥æ‘„åƒå¤´APIæ”¯æŒ
            if (!navigator.mediaDevices && !navigator.getUserMedia &&
                !navigator.webkitGetUserMedia && !navigator.mozGetUserMedia) {
                issues.push("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®ï¼ˆä½†ä»å¯ä½¿ç”¨å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼‰");
            }

            // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯åˆ°é¡µé¢
            displayBrowserInfo(browser);

            return {
                compatible: issues.length === 0,
                issues: issues,
                browser: browser
            };
        }

        // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
        function displayBrowserInfo(browser) {
            const browserBadge = document.createElement('div');
            browserBadge.id = 'browserBadge';
            browserBadge.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50';
            browserBadge.style.maxWidth = '300px';

            const deviceType = browser.isIOS ? 'ğŸ“± iOS' : browser.isAndroid ? 'ğŸ“± Android' : 'ğŸ–¥ï¸ æ¡Œé¢';
            const optimized = browser.isMobile ? 'âœ… å·²ä¼˜åŒ–' : 'âœ… å®Œå…¨æ”¯æŒ';

            browserBadge.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-semibold">${deviceType} ${browser.name}</div>
                        <div class="text-xs opacity-90">${optimized}</div>
                    </div>
                    <button onclick="document.getElementById('browserBadge').style.display='none'" class="ml-3 text-white hover:text-gray-200">
                        âœ•
                    </button>
                </div>
            `;

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (browserBadge && browserBadge.parentNode) {
                    browserBadge.style.opacity = '0';
                    browserBadge.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (browserBadge.parentNode) {
                            browserBadge.remove();
                        }
                    }, 500);
                }
            }, 8000);

            document.body.appendChild(browserBadge);
        }

        // æ˜¾ç¤ºå…¼å®¹æ€§è­¦å‘Š
        function showCompatibilityWarning(issues, browser) {
            const loader = document.getElementById('initialLoader');
            const isCritical = issues.some(issue =>
                issue.includes('Canvas') ||
                issue.includes('WebGL') ||
                issue.includes('Internet Explorer')
            );

            if (isCritical) {
                // ä¸¥é‡ä¸å…¼å®¹
                loader.querySelector('.loader-content').innerHTML = `
                    <div class="text-white">
                        <svg class="mx-auto h-20 w-20 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <p class="text-2xl font-semibold mb-4">æµè§ˆå™¨ä¸å…¼å®¹</p>
                        <p class="text-sm mb-4">æ£€æµ‹åˆ° ${browser.name} ${browser.version}</p>
                        <div class="text-left max-w-md mx-auto mb-6 bg-white bg-opacity-20 p-4 rounded">
                            <p class="font-semibold mb-2">å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š</p>
                            <ul class="text-sm space-y-1">
                                ${issues.map(issue => `<li>â€¢ ${issue}</li>`).join('')}
                            </ul>
                        </div>
                        <p class="text-sm mb-6">æ¨èä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨çš„æœ€æ–°ç‰ˆæœ¬ï¼š</p>
                        <div class="flex justify-center gap-4 text-sm">
                            <div>Chrome 90+</div>
                            <div>Firefox 88+</div>
                            <div>Safari 14+</div>
                            <div>Edge 90+</div>
                        </div>
                    </div>
                `;
                return false;
            } else {
                // éƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨ï¼Œä½†å¯ä»¥ç»§ç»­
                console.warn('æµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Š:', issues);

                // æ˜¾ç¤ºè­¦å‘Šä½†ç»§ç»­åŠ è½½
                if (issues.length > 0) {
                    setTimeout(() => {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4';
                        warningDiv.innerHTML = `
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700 font-semibold">æµè§ˆå™¨å…¼å®¹æ€§æç¤º</p>
                                    <ul class="mt-2 text-sm text-yellow-700 list-disc list-inside">
                                        ${issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                        document.querySelector('main').insertBefore(warningDiv, document.querySelector('main').firstChild);
                    }, 1000);
                }
                return true;
            }
        }

        let model = null;
        let webcamStream = null;
        let isDetecting = false;

        // ç¿»è¯‘å¸¸è§ç‰©å“åç§°åˆ°ä¸­æ–‡
        const translations = {
            'person': 'äºº',
            'bicycle': 'è‡ªè¡Œè½¦',
            'car': 'æ±½è½¦',
            'motorcycle': 'æ‘©æ‰˜è½¦',
            'airplane': 'é£æœº',
            'bus': 'å…¬å…±æ±½è½¦',
            'train': 'ç«è½¦',
            'truck': 'å¡è½¦',
            'boat': 'èˆ¹',
            'traffic light': 'äº¤é€šä¿¡å·ç¯',
            'fire hydrant': 'æ¶ˆé˜²æ “',
            'stop sign': 'åœè½¦æ ‡å¿—',
            'parking meter': 'åœè½¦è®¡æ—¶å™¨',
            'bench': 'é•¿å‡³',
            'bird': 'é¸Ÿ',
            'cat': 'çŒ«',
            'dog': 'ç‹—',
            'horse': 'é©¬',
            'sheep': 'ç¾Š',
            'cow': 'ç‰›',
            'elephant': 'å¤§è±¡',
            'bear': 'ç†Š',
            'zebra': 'æ–‘é©¬',
            'giraffe': 'é•¿é¢ˆé¹¿',
            'backpack': 'èƒŒåŒ…',
            'umbrella': 'é›¨ä¼',
            'handbag': 'æ‰‹æåŒ…',
            'tie': 'é¢†å¸¦',
            'suitcase': 'è¡Œæç®±',
            'frisbee': 'é£ç›˜',
            'skis': 'æ»‘é›ªæ¿',
            'snowboard': 'æ»‘é›ªæ¿',
            'sports ball': 'è¿åŠ¨çƒ',
            'kite': 'é£ç­',
            'baseball bat': 'æ£’çƒæ£’',
            'baseball glove': 'æ£’çƒæ‰‹å¥—',
            'skateboard': 'æ»‘æ¿',
            'surfboard': 'å†²æµªæ¿',
            'tennis racket': 'ç½‘çƒæ‹',
            'bottle': 'ç“¶å­',
            'wine glass': 'é…’æ¯',
            'cup': 'æ¯å­',
            'fork': 'å‰å­',
            'knife': 'åˆ€',
            'spoon': 'å‹ºå­',
            'bowl': 'ç¢—',
            'banana': 'é¦™è•‰',
            'apple': 'è‹¹æœ',
            'sandwich': 'ä¸‰æ˜æ²»',
            'orange': 'æ©™å­',
            'broccoli': 'è¥¿å…°èŠ±',
            'carrot': 'èƒ¡èåœ',
            'hot dog': 'çƒ­ç‹—',
            'pizza': 'æŠ«è¨',
            'donut': 'ç”œç”œåœˆ',
            'cake': 'è›‹ç³•',
            'chair': 'æ¤…å­',
            'couch': 'æ²™å‘',
            'potted plant': 'ç›†æ ½',
            'bed': 'åºŠ',
            'dining table': 'é¤æ¡Œ',
            'toilet': 'é©¬æ¡¶',
            'tv': 'ç”µè§†',
            'laptop': 'ç¬”è®°æœ¬ç”µè„‘',
            'mouse': 'é¼ æ ‡',
            'remote': 'é¥æ§å™¨',
            'keyboard': 'é”®ç›˜',
            'cell phone': 'æ‰‹æœº',
            'microwave': 'å¾®æ³¢ç‚‰',
            'oven': 'çƒ¤ç®±',
            'toaster': 'çƒ¤é¢åŒ…æœº',
            'sink': 'æ°´æ§½',
            'refrigerator': 'å†°ç®±',
            'book': 'ä¹¦',
            'clock': 'æ—¶é’Ÿ',
            'vase': 'èŠ±ç“¶',
            'scissors': 'å‰ªåˆ€',
            'teddy bear': 'æ³°è¿ªç†Š',
            'hair drier': 'å¹é£æœº',
            'toothbrush': 'ç‰™åˆ·'
        };

        // åŠ è½½æ¨¡å‹
        async function loadModel() {
            // å…ˆæ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            const compatibility = checkBrowserCompatibility();

            if (!compatibility.compatible) {
                const canContinue = showCompatibilityWarning(compatibility.issues, compatibility.browser);
                if (!canContinue) {
                    return; // ä¸¥é‡ä¸å…¼å®¹ï¼Œåœæ­¢åŠ è½½
                }
            }

            try {
                console.log('å¼€å§‹åŠ è½½æ¨¡å‹...');

                // æ›´æ–°åŠ è½½æç¤º
                const loaderText = document.querySelector('.loader-subtext');
                if (loaderText) {
                    loaderText.textContent = 'æ­£åœ¨åˆå§‹åŒ– TensorFlow.js...';
                }

                model = await cocoSsd.load();
                console.log('æ¨¡å‹åŠ è½½æˆåŠŸ');

                // éšè—å…¨å±åŠ è½½åŠ¨ç”»
                const loader = document.getElementById('initialLoader');
                loader.classList.add('fade-out');

                // åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);

                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');

                // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                console.log('%câœ“ ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ', 'color: #10B981; font-size: 14px; font-weight: bold;');
                console.log(`æµè§ˆå™¨: ${compatibility.browser.name} ${compatibility.browser.version}`);
            } catch (error) {
                console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);

                // æ›´æ–°åŠ è½½å™¨æ˜¾ç¤ºé”™è¯¯
                const loader = document.getElementById('initialLoader');
                let errorMessage = error.message;

                // æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('WebGL')) {
                    errorMessage = 'WebGL ä¸å¯ç”¨ã€‚è¯·ç¡®ä¿æ‚¨çš„æµè§ˆå™¨æ”¯æŒç¡¬ä»¶åŠ é€Ÿã€‚';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ— æ³•ä¸‹è½½AIæ¨¡å‹ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚';
                }

                loader.querySelector('.loader-content').innerHTML = `
                    <div class="text-white">
                        <svg class="mx-auto h-20 w-20 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-2xl font-semibold mb-4">æ¨¡å‹åŠ è½½å¤±è´¥</p>
                        <p class="text-sm mb-6">${errorMessage}</p>
                        <button onclick="location.reload()" class="bg-white text-purple-600 font-bold py-3 px-8 rounded-lg hover:bg-gray-100 transition duration-300">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
            }
        }

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        document.getElementById('imageUpload').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // åœæ­¢æ‘„åƒå¤´
            stopWebcam();

            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d');

                    // è®¾ç½®canvaså¤§å°
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // ç»˜åˆ¶å›¾ç‰‡
                    ctx.drawImage(img, 0, 0);

                    // æ˜¾ç¤ºå›¾ç‰‡å®¹å™¨
                    document.getElementById('imageContainer').classList.remove('hidden');
                    document.getElementById('cameraContainer').classList.add('hidden');
                    document.getElementById('noResults').classList.add('hidden');

                    // è¿›è¡Œé¢„æµ‹
                    await detectObjects(img, canvas);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ç‰©ä½“æ£€æµ‹
        async function detectObjects(image, canvas) {
            if (!model) return;

            try {
                const predictions = await model.detect(image);
                console.log('æ£€æµ‹ç»“æœ:', predictions);

                // ç»˜åˆ¶æ£€æµ‹æ¡†
                const ctx = canvas.getContext('2d');
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#10B981';
                ctx.fillStyle = '#10B981';
                ctx.font = 'bold 16px Arial';

                predictions.forEach(prediction => {
                    const [x, y, width, height] = prediction.bbox;

                    // ç»˜åˆ¶è¾¹ç•Œæ¡†
                    ctx.strokeRect(x, y, width, height);

                    // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
                    const label = `${translations[prediction.class] || prediction.class} ${Math.round(prediction.score * 100)}%`;
                    const textWidth = ctx.measureText(label).width;
                    ctx.fillRect(x, y - 25, textWidth + 10, 25);

                    // ç»˜åˆ¶æ ‡ç­¾æ–‡å­—
                    ctx.fillStyle = 'white';
                    ctx.fillText(label, x + 5, y - 7);
                    ctx.fillStyle = '#10B981';
                });

                // æ˜¾ç¤ºç»“æœåˆ—è¡¨
                displayResults(predictions);
            } catch (error) {
                console.error('æ£€æµ‹å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºç»“æœåˆ—è¡¨
        function displayResults(predictions) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsList = document.getElementById('resultsList');

            if (predictions.length === 0) {
                resultsContainer.classList.add('hidden');
                return;
            }

            resultsContainer.classList.remove('hidden');

            resultsList.innerHTML = predictions.map((prediction, index) => {
                const percentage = Math.round(prediction.score * 100);
                const colorClass = percentage > 70 ? 'bg-green-500' : percentage > 50 ? 'bg-yellow-500' : 'bg-orange-500';

                return `
                    <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 ${colorClass} rounded-full flex items-center justify-center text-white font-bold">
                                ${index + 1}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${translations[prediction.class] || prediction.class}</p>
                                <p class="text-sm text-gray-500">${prediction.class}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold ${colorClass.replace('bg-', 'text-')}">${percentage}%</p>
                            <p class="text-xs text-gray-500">ç½®ä¿¡åº¦</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å¯åŠ¨æ‘„åƒå¤´
        document.getElementById('enableCamera').addEventListener('click', async () => {
            try {
                // æ£€æŸ¥æ‘„åƒå¤´APIæ˜¯å¦å¯ç”¨
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®åŠŸèƒ½');
                }

                // ä½¿ç”¨è‡ªé€‚åº”é…ç½®
                const config = adaptiveConfig || getAdaptiveConfig(browserInfo || detectBrowser());

                console.log('%cğŸ“¹ å¯åŠ¨æ‘„åƒå¤´', 'color: #10B981; font-size: 14px; font-weight: bold;');
                console.log('ä½¿ç”¨é…ç½®:', config.videoConstraints);
                console.log('æµè§ˆå™¨:', browserInfo ? browserInfo.name : 'æœªçŸ¥');

                // æ ¹æ®è‡ªé€‚åº”é…ç½®è®¾ç½®è§†é¢‘å‚æ•°
                const videoConstraints = { ...config.videoConstraints };

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: videoConstraints
                });

                const video = document.getElementById('webcam');

                // æ ¹æ®é…ç½®åº”ç”¨è§†é¢‘å±æ€§
                video.setAttribute('playsinline', 'true');
                video.setAttribute('webkit-playsinline', 'true');

                if (config.requiresMuted) {
                    video.muted = true; // iOSå’ŒæŸäº›ç§»åŠ¨æµè§ˆå™¨éœ€è¦é™éŸ³æ‰èƒ½è‡ªåŠ¨æ’­æ”¾
                }

                video.srcObject = stream;
                webcamStream = stream;

                // ç¡®ä¿è§†é¢‘å¼€å§‹æ’­æ”¾
                video.play().catch(e => {
                    console.log('è§†é¢‘è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œå°è¯•ç”¨æˆ·äº¤äº’åæ’­æ”¾:', e);
                    // æœ‰äº›æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾
                });

                video.addEventListener('loadeddata', () => {
                    const canvas = document.getElementById('videoCanvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    document.getElementById('imageContainer').classList.add('hidden');
                    document.getElementById('cameraContainer').classList.remove('hidden');
                    document.getElementById('noResults').classList.add('hidden');
                    document.getElementById('enableCamera').classList.add('hidden');
                    document.getElementById('stopCamera').classList.remove('hidden');

                    isDetecting = true;
                    detectFrame(video, canvas);
                });
            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);

                let errorMessage = 'æ— æ³•è®¿é—®æ‘„åƒå¤´';
                let errorDetail = '';

                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“çš„æç¤º
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»';
                    errorDetail = 'è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®æ‘„åƒå¤´ï¼Œç„¶ååˆ·æ–°é¡µé¢é‡è¯•ã€‚';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = 'æœªæ£€æµ‹åˆ°æ‘„åƒå¤´';
                    errorDetail = 'è¯·ç¡®ä¿æ‚¨çš„è®¾å¤‡æœ‰æ‘„åƒå¤´ï¼Œæˆ–è€…å°è¯•è¿æ¥å¤–éƒ¨æ‘„åƒå¤´ã€‚';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = 'æ‘„åƒå¤´æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨';
                    errorDetail = 'è¯·å…³é—­å…¶ä»–æ­£åœ¨ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨ï¼Œç„¶åé‡è¯•ã€‚';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage = 'æ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„é…ç½®';
                    errorDetail = 'æ‚¨çš„æ‘„åƒå¤´å¯èƒ½ä¸æ”¯æŒé«˜åˆ†è¾¨ç‡ï¼Œç³»ç»Ÿå°†å°è¯•ä½¿ç”¨é»˜è®¤è®¾ç½®ã€‚';
                } else if (error.message.includes('ä¸æ”¯æŒ')) {
                    errorMessage = 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½';
                    errorDetail = 'è¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safari æˆ– Edgeï¼‰çš„æœ€æ–°ç‰ˆæœ¬ã€‚';
                } else {
                    errorDetail = error.message;
                }

                // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                alert(`${errorMessage}\n\n${errorDetail}\n\næç¤ºï¼šæ‚¨ä»å¯ä»¥ä½¿ç”¨å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½è¿›è¡Œç‰©å“è¯†åˆ«ã€‚`);
            }
        });

        // åœæ­¢æ‘„åƒå¤´
        document.getElementById('stopCamera').addEventListener('click', stopWebcam);

        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            isDetecting = false;
            document.getElementById('cameraContainer').classList.add('hidden');
            document.getElementById('enableCamera').classList.remove('hidden');
            document.getElementById('stopCamera').classList.add('hidden');
            document.getElementById('resultsContainer').classList.add('hidden');
            if (document.getElementById('imageContainer').classList.contains('hidden')) {
                document.getElementById('noResults').classList.remove('hidden');
            }
        }

        // å®æ—¶æ£€æµ‹
        async function detectFrame(video, canvas) {
            if (!isDetecting) return;

            const predictions = await model.detect(video);

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶æ£€æµ‹æ¡†
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#10B981';
            ctx.fillStyle = '#10B981';
            ctx.font = 'bold 16px Arial';

            predictions.forEach(prediction => {
                const [x, y, width, height] = prediction.bbox;

                ctx.strokeRect(x, y, width, height);

                const label = `${translations[prediction.class] || prediction.class} ${Math.round(prediction.score * 100)}%`;
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(x, y - 25, textWidth + 10, 25);

                ctx.fillStyle = 'white';
                ctx.fillText(label, x + 5, y - 7);
                ctx.fillStyle = '#10B981';
            });

            displayResults(predictions);

            requestAnimationFrame(() => detectFrame(video, canvas));
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', loadModel);
    </script>
</body>
</html>
