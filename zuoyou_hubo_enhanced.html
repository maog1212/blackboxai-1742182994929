<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å·¦å³äº’ææœ¯">
    <meta name="theme-color" content="#667eea">
    <title>å·¦å³äº’ææœ¯ç»ƒä¹  - å¢å¼ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue",
                         "Microsoft YaHei", "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right)
                     env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            padding: 30px 0 20px;
            animation: fadeInDown 0.8s ease;
        }

        .title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 5px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            letter-spacing: 2px;
        }

        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            margin-top: 10px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            color: #333;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .character-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .character-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
            border: 3px solid transparent;
        }

        .character-card:active {
            transform: scale(0.95);
        }

        .character-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .character-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .character-title {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .character-specialty {
            font-size: 11px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 5px;
            border-radius: 5px;
        }

        .button {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button.secondary {
            background: #fff;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .button.camera {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .difficulty-option {
            background: white;
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .difficulty-option:active {
            transform: scale(0.98);
        }

        .difficulty-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .difficulty-name {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .difficulty-rounds {
            color: #666;
            font-size: 14px;
        }

        .battle-arena {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .round-info {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .hands-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 30px 0;
        }

        .hand {
            text-align: center;
            flex: 1;
            padding: 15px;
        }

        .hand-icon {
            font-size: 60px;
            margin-bottom: 10px;
            animation: float 2s ease-in-out infinite;
        }

        .left-hand .hand-icon {
            animation-delay: 0s;
        }

        .right-hand .hand-icon {
            animation-delay: 0.5s;
        }

        .hand-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .move-name {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
            margin: 8px 0;
        }

        .move-type {
            font-size: 12px;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 5px;
            display: inline-block;
        }

        .vs-icon {
            font-size: 30px;
            color: #ff6b6b;
            animation: pulse 1s ease-in-out infinite;
        }

        .result-message {
            text-align: center;
            font-size: 16px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .result-icon {
            font-size: 30px;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .proficiency-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            margin: 15px 0;
            color: white;
        }

        .proficiency-value {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .proficiency-label {
            font-size: 16px;
            opacity: 0.9;
        }

        .evaluation {
            text-align: center;
            font-size: 18px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #ffd700;
        }

        /* æ‰‹åŠ¿è¯†åˆ«ç›¸å…³ */
        .gesture-mode {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
        }

        .gesture-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255,255,255,0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #4caf50;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .camera-preview {
            width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin: 15px 0;
            display: none;
            object-fit: cover;
        }

        .camera-preview.active {
            display: block;
        }

        .gesture-hint {
            font-size: 13px;
            color: #333;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .counter-hint {
            font-size: 13px;
            color: #ffeb3b;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255,235,59,0.2);
            border-radius: 8px;
        }

        .coordination-gain {
            display: inline-block;
            color: #4caf50;
            font-weight: bold;
            margin-left: 10px;
            animation: bounceIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
        }

        .info-text {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin: 10px 0;
        }

        .feature-list {
            text-align: left;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 10px 0;
        }

        .feature-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .feature-item:last-child {
            border-bottom: none;
        }

        /* Chromeä¼˜åŒ– */
        @supports (-webkit-appearance: none) {
            .button, .character-card, .difficulty-option {
                -webkit-appearance: none;
            }
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 350px) {
            .title {
                font-size: 24px;
            }
            .character-grid {
                grid-template-columns: 1fr;
            }
            .hand-icon {
                font-size: 45px;
            }
        }

        @media (min-width: 768px) {
            .container {
                max-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">å·¦å³äº’ææœ¯</div>
            <div class="subtitle">Left-Right Fighting Training</div>
            <div class="badge">âœ¨ iPhone Safari/Chrome å®Œç¾å…¼å®¹</div>
        </div>

        <!-- ä¸»èœå• -->
        <div id="menuScreen" class="screen active">
            <div class="card">
                <div class="card-title">é€‰æ‹©è§’è‰²</div>
                <div class="character-grid">
                    <div class="character-card" data-character="0">
                        <div class="character-name">éƒ­é–</div>
                        <div class="character-title">åŒ—ä¾ </div>
                        <div class="character-specialty">é™é¾™åå…«æŒ</div>
                    </div>
                    <div class="character-card" data-character="1">
                        <div class="character-name">å°é¾™å¥³</div>
                        <div class="character-title">å¤å¢“ä»™å­</div>
                        <div class="character-specialty">ç‰å¥³å¿ƒç»</div>
                    </div>
                    <div class="character-card" data-character="2">
                        <div class="character-name">æ¨è¿‡</div>
                        <div class="character-title">ç¥é›•ä¾ </div>
                        <div class="character-specialty">é»¯ç„¶é”€é­‚æŒ</div>
                    </div>
                    <div class="character-card" data-character="3">
                        <div class="character-name">å‘¨ä¼¯é€š</div>
                        <div class="character-title">è€é¡½ç«¥</div>
                        <div class="character-specialty">å·¦å³äº’æ</div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹åŠ¿è¯†åˆ«æ¨¡å¼ -->
            <div class="card gesture-mode">
                <div style="font-weight: bold; margin-bottom: 10px;">ğŸ¥ æ‰‹åŠ¿è¯†åˆ«æ¨¡å¼ï¼ˆå®éªŒæ€§ï¼‰</div>
                <div class="gesture-toggle">
                    <span>æ‰‹åŠ¿æ§åˆ¶</span>
                    <div class="toggle-switch" id="gestureToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="gesture-hint">
                    å¼€å¯åå¯ä½¿ç”¨æ‘„åƒå¤´è¯†åˆ«æ‰‹åŠ¿æ¥é€‰æ‹©æ‹›å¼
                    <br>éœ€è¦æµè§ˆå™¨æ‘„åƒå¤´æƒé™
                </div>
            </div>

            <button id="startButton" class="button" disabled>å¼€å§‹ç»ƒä¹ </button>
        </div>

        <!-- éš¾åº¦é€‰æ‹© -->
        <div id="difficultyScreen" class="screen">
            <div class="card">
                <div class="card-title">é€‰æ‹©éš¾åº¦</div>
                <div class="difficulty-option" data-difficulty="0">
                    <div>
                        <div class="difficulty-name">ğŸŒ± åˆå­¦</div>
                        <div class="info-text">é€‚åˆæ–°æ‰‹å…¥é—¨</div>
                    </div>
                    <div class="difficulty-rounds">10å›åˆ</div>
                </div>
                <div class="difficulty-option" data-difficulty="1">
                    <div>
                        <div class="difficulty-name">ğŸ’« ç†Ÿç»ƒ</div>
                        <div class="info-text">æŒæ¡åŸºç¡€æŠ€å·§</div>
                    </div>
                    <div class="difficulty-rounds">20å›åˆ</div>
                </div>
                <div class="difficulty-option" data-difficulty="2">
                    <div>
                        <div class="difficulty-name">â­ ç²¾é€š</div>
                        <div class="info-text">è¿½æ±‚æ›´é«˜å¢ƒç•Œ</div>
                    </div>
                    <div class="difficulty-rounds">30å›åˆ</div>
                </div>
                <div class="difficulty-option" data-difficulty="3">
                    <div>
                        <div class="difficulty-name">ğŸ† å®—å¸ˆ</div>
                        <div class="info-text">æŒ‘æˆ˜æé™</div>
                    </div>
                    <div class="difficulty-rounds">50å›åˆ</div>
                </div>
            </div>

            <button id="confirmDifficulty" class="button" disabled>ç¡®è®¤å¼€å§‹</button>
            <button id="backToMenu" class="button back-button">è¿”å›</button>
        </div>

        <!-- æˆ˜æ–—åœºæ™¯ -->
        <div id="battleScreen" class="screen">
            <!-- æ‘„åƒå¤´é¢„è§ˆï¼ˆæ‰‹åŠ¿æ¨¡å¼ï¼‰ -->
            <video id="cameraPreview" class="camera-preview" autoplay playsinline></video>
            <canvas id="gestureCanvas" style="display: none;"></canvas>

            <div class="battle-arena">
                <div class="round-info">
                    <div>ç¬¬ <span id="currentRound">1</span> / <span id="totalRounds">20</span> å›åˆ</div>
                    <div id="gestureStatus" style="font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>

                <div class="hands-container">
                    <div class="hand left-hand">
                        <div class="hand-icon">ğŸ‘ˆ</div>
                        <div class="hand-label">å·¦æ‰‹</div>
                        <div class="move-name" id="leftMove">å‡†å¤‡ä¸­...</div>
                        <div class="move-type" id="leftType"></div>
                    </div>

                    <div class="vs-icon">âš”ï¸</div>

                    <div class="hand right-hand">
                        <div class="hand-icon">ğŸ‘‰</div>
                        <div class="hand-label">å³æ‰‹</div>
                        <div class="move-name" id="rightMove">å‡†å¤‡ä¸­...</div>
                        <div class="move-type" id="rightType"></div>
                    </div>
                </div>

                <div class="result-message" id="resultMessage">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div id="counterHint" class="counter-hint" style="display: none;"></div>

                <div style="color: white; text-align: center; margin-top: 15px;">
                    <div>åè°ƒåº¦: <span id="coordination">0</span> <span id="coordinationGain"></span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="roundProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <button id="nextRound" class="button">ä¸‹ä¸€å›åˆ</button>
            <button id="stopGesture" class="button secondary" style="display: none;">å…³é—­æ‘„åƒå¤´</button>
        </div>

        <!-- ç»“æœç»Ÿè®¡ -->
        <div id="resultScreen" class="screen">
            <div class="card">
                <div class="card-title">ğŸŠ ç»ƒä¹ å®Œæˆ</div>

                <div class="proficiency-display">
                    <div class="proficiency-label">ç†Ÿç»ƒåº¦</div>
                    <div class="proficiency-value" id="proficiencyValue">0%</div>
                    <div class="proficiency-label">åè°ƒåº¦: <span id="finalCoordination">0</span></div>
                </div>

                <div class="evaluation" id="evaluation">
                    ç»§ç»­åŠªåŠ›ï¼
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="leftWins">0</div>
                        <div class="stat-label">ğŸ‘ˆ å·¦æ‰‹è·èƒœ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="rightWins">0</div>
                        <div class="stat-label">ğŸ‘‰ å³æ‰‹è·èƒœ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="draws">0</div>
                        <div class="stat-label">âš”ï¸ åŠ¿å‡åŠ›æ•Œ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalRoundsPlayed">0</div>
                        <div class="stat-label">ğŸ“Š æ€»å›åˆ</div>
                    </div>
                </div>

                <div class="feature-list" id="gestureStats" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: white;">æ‰‹åŠ¿è¯†åˆ«ç»Ÿè®¡</div>
                    <div class="feature-item" style="color: white;">
                        æ‰‹åŠ¿è¯†åˆ«æ¬¡æ•°: <span id="gestureCount">0</span>
                    </div>
                </div>
            </div>

            <button id="playAgain" class="button">å†æ¬¡ç»ƒä¹ </button>
            <button id="backToMenuFromResult" class="button back-button">è¿”å›ä¸»èœå•</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®
        const characters = [
            { name: 'éƒ­é–', title: 'åŒ—ä¾ ', basePower: 90, specialty: 'é™é¾™åå…«æŒ' },
            { name: 'å°é¾™å¥³', title: 'å¤å¢“ä»™å­', basePower: 88, specialty: 'ç‰å¥³å¿ƒç»' },
            { name: 'æ¨è¿‡', title: 'ç¥é›•ä¾ ', basePower: 92, specialty: 'é»¯ç„¶é”€é­‚æŒ' },
            { name: 'å‘¨ä¼¯é€š', title: 'è€é¡½ç«¥', basePower: 95, specialty: 'å·¦å³äº’æ' }
        ];

        const moves = [
            { name: 'äº¢é¾™æœ‰æ‚”', type: 'æŒ', power: 95, desc: 'é™é¾™åå…«æŒç¬¬ä¸€å¼' },
            { name: 'é£é¾™åœ¨å¤©', type: 'æŒ', power: 90, desc: 'é™é¾™åå…«æŒç¬¬äºŒå¼' },
            { name: 'ç©ºæ˜æ‹³', type: 'æ‹³', power: 85, desc: 'å¤å¢“æ´¾ç»å­¦' },
            { name: 'ç‰å¥³ç´ å¿ƒå‰‘', type: 'å‰‘', power: 88, desc: 'å¤å¢“æ´¾å‰‘æ³•' },
            { name: 'ä¸€é˜³æŒ‡', type: 'æŒ‡', power: 92, desc: 'å¤§ç†æ®µæ°ç»å­¦' },
            { name: 'å…­è„‰ç¥å‰‘', type: 'æŒ‡', power: 98, desc: 'å¤§ç†æ®µæ°æœ€é«˜æ­¦å­¦' },
            { name: 'å¤ªææ‹³', type: 'æ‹³', power: 80, desc: 'ä»¥æŸ”å…‹åˆš' },
            { name: 'é»¯ç„¶é”€é­‚æŒ', type: 'æŒ', power: 96, desc: 'æ¨è¿‡ç‹¬åˆ›' },
            { name: 'å¼¹æŒ‡ç¥é€š', type: 'æŒ‡', power: 87, desc: 'ä¸œé‚ªé»„è¯å¸ˆç»å­¦' },
            { name: 'è›¤èŸ†åŠŸ', type: 'å†…åŠŸ', power: 89, desc: 'è¥¿æ¯’æ¬§é˜³é”‹ç»å­¦' },
            { name: 'ä¹é˜´çœŸç»', type: 'å†…åŠŸ', power: 94, desc: 'æ­¦å­¦è‡³é«˜ç§˜ç±' },
            { name: 'æ‰“ç‹—æ£’æ³•', type: 'æ£', power: 86, desc: 'ä¸å¸®å¸®ä¸»ç‹¬é—¨æ­¦å­¦' },
            { name: 'ä¸ƒä¼¤æ‹³', type: 'æ‹³', power: 91, desc: 'ä¼¤äººäº¦ä¼¤å·±' },
            { name: 'é¾™çˆªæ‰‹', type: 'æŒ', power: 84, desc: 'åˆšçŒ›å‡Œå‰' }
        ];

        const counterSystem = {
            'æ‹³': ['æŒ', 'æ£'],
            'æŒ': ['æŒ‡', 'å‰‘'],
            'æŒ‡': ['æ‹³', 'å†…åŠŸ'],
            'å‰‘': ['æ‹³', 'æ£'],
            'å†…åŠŸ': ['æŒ', 'å‰‘'],
            'æ£': ['æŒ‡', 'å†…åŠŸ']
        };

        const difficulties = [
            { name: 'åˆå­¦', rounds: 10 },
            { name: 'ç†Ÿç»ƒ', rounds: 20 },
            { name: 'ç²¾é€š', rounds: 30 },
            { name: 'å®—å¸ˆ', rounds: 50 }
        ];

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            selectedCharacter: null,
            selectedDifficulty: null,
            currentRound: 0,
            totalRounds: 0,
            coordination: 0,
            leftWins: 0,
            rightWins: 0,
            draws: 0,
            gestureMode: false,
            gestureCount: 0,
            cameraStream: null
        };

        // å±å¹•åˆ‡æ¢
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // æ‰‹åŠ¿è¯†åˆ«å¼€å…³
        const gestureToggle = document.getElementById('gestureToggle');
        gestureToggle.addEventListener('click', function() {
            gameState.gestureMode = !gameState.gestureMode;
            this.classList.toggle('active');

            if (gameState.gestureMode) {
                console.log('æ‰‹åŠ¿è¯†åˆ«æ¨¡å¼å·²å¼€å¯');
            } else {
                console.log('æ‰‹åŠ¿è¯†åˆ«æ¨¡å¼å·²å…³é—­');
                stopCamera();
            }
        });

        // æ‘„åƒå¤´æ§åˆ¶
        async function startCamera() {
            if (!gameState.gestureMode) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' }
                });
                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;
                video.classList.add('active');
                gameState.cameraStream = stream;

                document.getElementById('gestureStatus').style.display = 'block';
                document.getElementById('gestureStatus').textContent = 'ğŸ“· æ‘„åƒå¤´å·²å¯åŠ¨';
                document.getElementById('stopGesture').style.display = 'block';

                // ç®€å•çš„æ‰‹åŠ¿æ£€æµ‹ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                detectGesture();
            } catch (err) {
                console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', err);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                gameState.gestureMode = false;
                gestureToggle.classList.remove('active');
            }
        }

        function stopCamera() {
            if (gameState.cameraStream) {
                gameState.cameraStream.getTracks().forEach(track => track.stop());
                gameState.cameraStream = null;
                const video = document.getElementById('cameraPreview');
                video.classList.remove('active');
                video.srcObject = null;
                document.getElementById('gestureStatus').style.display = 'none';
                document.getElementById('stopGesture').style.display = 'none';
            }
        }

        // ç®€å•çš„æ‰‹åŠ¿æ£€æµ‹ï¼ˆæ¼”ç¤ºç”¨ - å®é™…åº”ç”¨å¯é›†æˆTensorFlow.jsæˆ–MediaPipeï¼‰
        function detectGesture() {
            // è¿™é‡Œåªæ˜¯æ¼”ç¤ºæ¡†æ¶ï¼Œå®é™…æ‰‹åŠ¿è¯†åˆ«éœ€è¦MLåº“
            if (!gameState.gestureMode || !gameState.cameraStream) return;

            // æ¨¡æ‹Ÿæ‰‹åŠ¿æ£€æµ‹
            setTimeout(() => {
                if (gameState.gestureMode && gameState.cameraStream) {
                    gameState.gestureCount++;
                    detectGesture(); // ç»§ç»­æ£€æµ‹
                }
            }, 1000);
        }

        document.getElementById('stopGesture').addEventListener('click', stopCamera);

        // è§’è‰²é€‰æ‹©
        document.querySelectorAll('.character-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                gameState.selectedCharacter = parseInt(this.dataset.character);
                document.getElementById('startButton').disabled = false;
            });
        });

        document.getElementById('startButton').addEventListener('click', () => {
            showScreen('difficultyScreen');
        });

        // éš¾åº¦é€‰æ‹©
        document.querySelectorAll('.difficulty-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                gameState.selectedDifficulty = parseInt(this.dataset.difficulty);
                document.getElementById('confirmDifficulty').disabled = false;
            });
        });

        document.getElementById('confirmDifficulty').addEventListener('click', () => {
            startGame();
        });

        document.getElementById('backToMenu').addEventListener('click', () => {
            showScreen('menuScreen');
        });

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            gameState.totalRounds = difficulties[gameState.selectedDifficulty].rounds;
            gameState.currentRound = 0;
            gameState.coordination = 0;
            gameState.leftWins = 0;
            gameState.rightWins = 0;
            gameState.draws = 0;
            gameState.gestureCount = 0;

            document.getElementById('totalRounds').textContent = gameState.totalRounds;
            showScreen('battleScreen');

            // å¦‚æœå¼€å¯æ‰‹åŠ¿æ¨¡å¼ï¼Œå¯åŠ¨æ‘„åƒå¤´
            if (gameState.gestureMode) {
                startCamera();
            }

            nextRound();
        }

        // ä¸‹ä¸€å›åˆ
        function nextRound() {
            if (gameState.currentRound >= gameState.totalRounds) {
                stopCamera();
                showResults();
                return;
            }

            gameState.currentRound++;
            document.getElementById('currentRound').textContent = gameState.currentRound;

            // éšæœºé€‰æ‹©æ‹›å¼ï¼ˆæˆ–é€šè¿‡æ‰‹åŠ¿è¯†åˆ«ï¼‰
            let leftMove, rightMove;

            if (gameState.gestureMode && Math.random() > 0.5) {
                // æ¨¡æ‹ŸåŸºäºæ‰‹åŠ¿çš„æ‹›å¼é€‰æ‹©
                leftMove = moves[Math.floor(Math.random() * moves.length)];
                rightMove = moves[Math.floor(Math.random() * moves.length)];
                if (document.getElementById('gestureStatus').style.display !== 'none') {
                    document.getElementById('gestureStatus').textContent = 'ğŸ“· æ£€æµ‹åˆ°æ‰‹åŠ¿ï¼';
                }
            } else {
                // éšæœºé€‰æ‹©
                do {
                    leftMove = moves[Math.floor(Math.random() * moves.length)];
                    rightMove = moves[Math.floor(Math.random() * moves.length)];
                } while (leftMove.name === rightMove.name);
            }

            // æ˜¾ç¤ºæ‹›å¼
            document.getElementById('leftMove').textContent = leftMove.name;
            document.getElementById('leftType').textContent = leftMove.type;
            document.getElementById('rightMove').textContent = rightMove.name;
            document.getElementById('rightType').textContent = rightMove.type;

            // è®¡ç®—ç»“æœ
            const result = calculateBattle(leftMove, rightMove);

            // æ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                displayResult(result, leftMove, rightMove);
            }, 500);

            // æ›´æ–°è¿›åº¦
            const progress = (gameState.currentRound / gameState.totalRounds) * 100;
            document.getElementById('roundProgress').style.width = progress + '%';
            document.getElementById('coordination').textContent = gameState.coordination;
        }

        // è®¡ç®—æˆ˜æ–—ç»“æœ
        function calculateBattle(leftMove, rightMove) {
            const character = characters[gameState.selectedCharacter];

            let leftPower = leftMove.power + Math.floor(Math.random() * 21) - 10;
            let rightPower = rightMove.power + Math.floor(Math.random() * 21) - 10;

            leftPower += character.basePower * 0.1;
            rightPower += character.basePower * 0.1;

            const leftCounters = counterSystem[leftMove.type]?.includes(rightMove.type);
            const rightCounters = counterSystem[rightMove.type]?.includes(leftMove.type);

            if (leftCounters) leftPower *= 1.3;
            if (rightCounters) rightPower *= 1.3;

            const powerDiff = Math.abs(leftPower - rightPower);

            let result;
            if (powerDiff < 15) {
                result = 'draw';
                gameState.draws++;
            } else if (leftPower > rightPower) {
                result = 'left';
                gameState.leftWins++;
            } else {
                result = 'right';
                gameState.rightWins++;
            }

            return { result, leftCounters, rightCounters };
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(battleResult, leftMove, rightMove) {
            const resultEl = document.getElementById('resultMessage');
            const counterHintEl = document.getElementById('counterHint');

            let icon, message, coordinationGain;

            if (battleResult.result === 'draw') {
                icon = 'âš”ï¸';
                message = 'åŠ¿å‡åŠ›æ•Œï¼Œéš¾åˆ†é«˜ä¸‹ï¼';
                coordinationGain = 5;
            } else if (battleResult.result === 'left') {
                icon = 'ğŸ’ª';
                message = 'å·¦æ‰‹å æ®ä¸Šé£ï¼';
                coordinationGain = 3;
            } else {
                icon = 'ğŸ’ª';
                message = 'å³æ‰‹ç•¥èƒœä¸€ç­¹ï¼';
                coordinationGain = 3;
            }

            resultEl.innerHTML = `
                <div class="result-icon">${icon}</div>
                <div>${message}</div>
            `;

            // æ˜¾ç¤ºç›¸å…‹ä¿¡æ¯
            let counterText = '';
            if (battleResult.leftCounters) {
                counterText += `âœ¨ å·¦æ‰‹${leftMove.type}å…‹åˆ¶å³æ‰‹${rightMove.type}ï¼`;
            }
            if (battleResult.rightCounters) {
                if (counterText) counterText += '<br>';
                counterText += `âœ¨ å³æ‰‹${rightMove.type}å…‹åˆ¶å·¦æ‰‹${leftMove.type}ï¼`;
            }

            if (counterText) {
                counterHintEl.innerHTML = counterText;
                counterHintEl.style.display = 'block';
            } else {
                counterHintEl.style.display = 'none';
            }

            // æ›´æ–°åè°ƒåº¦
            gameState.coordination += coordinationGain;
            document.getElementById('coordination').textContent = gameState.coordination;
            document.getElementById('coordinationGain').innerHTML =
                `<span class="coordination-gain">+${coordinationGain}</span>`;

            setTimeout(() => {
                document.getElementById('coordinationGain').innerHTML = '';
            }, 2000);
        }

        document.getElementById('nextRound').addEventListener('click', () => {
            nextRound();
        });

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            const proficiency = Math.min(100, gameState.coordination / 10);

            document.getElementById('proficiencyValue').textContent = proficiency.toFixed(1) + '%';
            document.getElementById('finalCoordination').textContent = gameState.coordination;
            document.getElementById('leftWins').textContent = gameState.leftWins;
            document.getElementById('rightWins').textContent = gameState.rightWins;
            document.getElementById('draws').textContent = gameState.draws;
            document.getElementById('totalRoundsPlayed').textContent = gameState.totalRounds;

            // æ‰‹åŠ¿ç»Ÿè®¡
            if (gameState.gestureMode && gameState.gestureCount > 0) {
                document.getElementById('gestureStats').style.display = 'block';
                document.getElementById('gestureCount').textContent = gameState.gestureCount;
            }

            let evaluation;
            if (proficiency >= 90) {
                evaluation = 'ğŸ† å®—å¸ˆçº§ï¼å·¦å³äº’æå·²è‡»åŒ–å¢ƒï¼';
            } else if (proficiency >= 70) {
                evaluation = 'â­ ç²¾é€šçº§ï¼å·¦å³æ‰‹å·²èƒ½å®Œç¾é…åˆï¼';
            } else if (proficiency >= 50) {
                evaluation = 'âœ¨ ç†Ÿç»ƒçº§ï¼å·¦å³æ‰‹åè°ƒæ€§å¤§å¹…æå‡ï¼';
            } else if (proficiency >= 30) {
                evaluation = 'ğŸ’« å…¥é—¨çº§ï¼å·²åˆæ­¥æŒæ¡å·¦å³äº’æè¦é¢†ï¼';
            } else {
                evaluation = 'ğŸŒ± åˆå­¦è€…ï¼ç»§ç»­åŠªåŠ›ç»ƒä¹ å§ï¼';
            }

            document.getElementById('evaluation').textContent = evaluation;

            showScreen('resultScreen');
        }

        document.getElementById('playAgain').addEventListener('click', () => {
            showScreen('difficultyScreen');
        });

        document.getElementById('backToMenuFromResult').addEventListener('click', () => {
            // é‡ç½®é€‰æ‹©
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            document.querySelectorAll('.difficulty-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('startButton').disabled = true;
            document.getElementById('confirmDifficulty').disabled = true;
            document.getElementById('gestureStats').style.display = 'none';
            showScreen('menuScreen');
        });

        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // æ·»åŠ è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        document.querySelectorAll('.button, .character-card, .difficulty-option').forEach(el => {
            el.addEventListener('click', vibrate);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });

        // æ£€æµ‹æµè§ˆå™¨
        const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);

        console.log('æµè§ˆå™¨æ£€æµ‹:', isChrome ? 'Chrome' : (isSafari ? 'Safari' : 'å…¶ä»–'));
        console.log('æ‰‹åŠ¿è¯†åˆ«æ”¯æŒ:', 'mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices);
    </script>
</body>
</html>
