"""
漏洞扫描服务主程序
"""
import os
import asyncio
from contextlib import asynccontextmanager
from fastapi import FastAPI, HTTPException, BackgroundTasks
from fastapi.middleware.cors import CORSMiddleware
from prometheus_client import Counter, Histogram, generate_latest
from fastapi.responses import Response
import logging

from scanner.scanner_engine import ScannerEngine
from scanner.asset_discovery import AssetDiscovery
from scanner.vulnerability_db import VulnerabilityDatabase
from scanner.scheduler import ScanScheduler
from models.scan_models import ScanRequest, ScanResponse, AssetInfo
from database.db_manager import DatabaseManager
from utils.logger import setup_logger

# 设置日志
logger = setup_logger(__name__)

# Prometheus指标
SCAN_COUNTER = Counter('vulnerability_scans_total', 'Total vulnerability scans', ['status'])
SCAN_DURATION = Histogram('vulnerability_scan_duration_seconds', 'Scan duration')
VULNERABILITIES_FOUND = Counter('vulnerabilities_found_total', 'Total vulnerabilities found', ['severity'])

@asynccontextmanager
async def lifespan(app: FastAPI):
    """应用生命周期管理"""
    # 启动时
    logger.info("启动扫描器服务...")

    # 初始化数据库
    await app.state.db_manager.init_db()

    # 初始化漏洞数据库
    await app.state.vuln_db.initialize()

    # 启动调度器
    app.state.scheduler.start()

    logger.info("扫描器服务启动完成")

    yield

    # 关闭时
    logger.info("关闭扫描器服务...")
    app.state.scheduler.shutdown()
    await app.state.db_manager.close()
    logger.info("扫描器服务已关闭")

# 创建FastAPI应用
app = FastAPI(
    title="Vulnerability Scanner Service",
    description="自动化漏洞扫描服务",
    version="1.0.0",
    lifespan=lifespan
)

# CORS配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 初始化组件
app.state.db_manager = DatabaseManager()
app.state.scanner_engine = ScannerEngine(app.state.db_manager)
app.state.asset_discovery = AssetDiscovery()
app.state.vuln_db = VulnerabilityDatabase()
app.state.scheduler = ScanScheduler(app.state.scanner_engine)

@app.get("/health")
async def health_check():
    """健康检查"""
    return {
        "status": "healthy",
        "service": "scanner",
        "version": "1.0.0"
    }

@app.get("/metrics")
async def metrics():
    """Prometheus指标"""
    return Response(content=generate_latest(), media_type="text/plain")

@app.post("/scan", response_model=ScanResponse)
async def start_scan(scan_request: ScanRequest, background_tasks: BackgroundTasks):
    """
    启动漏洞扫描

    Args:
        scan_request: 扫描请求参数
        background_tasks: 后台任务

    Returns:
        扫描结果
    """
    try:
        logger.info(f"收到扫描请求: {scan_request.dict()}")

        # 创建扫描任务
        scan_id = await app.state.scanner_engine.create_scan_task(scan_request)

        # 在后台执行扫描
        background_tasks.add_task(
            app.state.scanner_engine.execute_scan,
            scan_id,
            scan_request
        )

        SCAN_COUNTER.labels(status='initiated').inc()

        return ScanResponse(
            scan_id=scan_id,
            status="initiated",
            message="扫描任务已创建"
        )

    except Exception as e:
        logger.error(f"创建扫描任务失败: {str(e)}")
        SCAN_COUNTER.labels(status='failed').inc()
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/scan/{scan_id}")
async def get_scan_status(scan_id: str):
    """
    获取扫描状态

    Args:
        scan_id: 扫描任务ID

    Returns:
        扫描状态信息
    """
    try:
        status = await app.state.scanner_engine.get_scan_status(scan_id)

        if not status:
            raise HTTPException(status_code=404, detail="扫描任务不存在")

        return status

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"获取扫描状态失败: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/scan/{scan_id}/results")
async def get_scan_results(scan_id: str):
    """
    获取扫描结果

    Args:
        scan_id: 扫描任务ID

    Returns:
        扫描结果详情
    """
    try:
        results = await app.state.scanner_engine.get_scan_results(scan_id)

        if not results:
            raise HTTPException(status_code=404, detail="扫描结果不存在")

        return results

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"获取扫描结果失败: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/discover-assets")
async def discover_assets(target_range: str):
    """
    资产发现

    Args:
        target_range: 目标范围（IP范围或网段）

    Returns:
        发现的资产列表
    """
    try:
        logger.info(f"开始资产发现: {target_range}")

        assets = await app.state.asset_discovery.discover(target_range)

        # 保存资产信息
        await app.state.db_manager.save_assets(assets)

        return {
            "discovered_assets": len(assets),
            "assets": assets
        }

    except Exception as e:
        logger.error(f"资产发现失败: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/update-vulnerability-db")
async def update_vulnerability_database(background_tasks: BackgroundTasks):
    """
    更新漏洞数据库

    Returns:
        更新状态
    """
    try:
        logger.info("开始更新漏洞数据库")

        background_tasks.add_task(app.state.vuln_db.update)

        return {
            "status": "updating",
            "message": "漏洞数据库更新已启动"
        }

    except Exception as e:
        logger.error(f"更新漏洞数据库失败: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/vulnerability-db/stats")
async def get_vulnerability_db_stats():
    """
    获取漏洞数据库统计信息

    Returns:
        统计信息
    """
    try:
        stats = await app.state.vuln_db.get_statistics()
        return stats

    except Exception as e:
        logger.error(f"获取统计信息失败: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/schedules")
async def get_scan_schedules():
    """
    获取扫描计划

    Returns:
        扫描计划列表
    """
    try:
        schedules = app.state.scheduler.get_schedules()
        return {"schedules": schedules}

    except Exception as e:
        logger.error(f"获取扫描计划失败: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/schedules")
async def create_scan_schedule(schedule_config: dict):
    """
    创建扫描计划

    Args:
        schedule_config: 计划配置

    Returns:
        创建结果
    """
    try:
        schedule_id = app.state.scheduler.add_schedule(schedule_config)

        return {
            "schedule_id": schedule_id,
            "status": "created",
            "message": "扫描计划已创建"
        }

    except Exception as e:
        logger.error(f"创建扫描计划失败: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn

    port = int(os.getenv("SCANNER_PORT", 8081))
    host = os.getenv("SCANNER_HOST", "0.0.0.0")

    uvicorn.run(
        "main:app",
        host=host,
        port=port,
        reload=True,
        log_level="info"
    )
