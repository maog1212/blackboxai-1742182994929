"""
扫描调度器模块
"""
import logging
from datetime import datetime
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from typing import Dict, List
import uuid

from scanner.scanner_engine import ScannerEngine
from models.scan_models import ScanRequest

logger = logging.getLogger(__name__)


class ScanScheduler:
    """扫描调度器"""

    def __init__(self, scanner_engine: ScannerEngine):
        self.scanner_engine = scanner_engine
        self.scheduler = AsyncIOScheduler()
        self.schedules: Dict[str, dict] = {}

    def start(self):
        """启动调度器"""
        logger.info("启动扫描调度器...")

        # 添加默认的扫描计划
        self._add_default_schedules()

        # 启动调度器
        self.scheduler.start()

        logger.info("扫描调度器已启动")

    def shutdown(self):
        """关闭调度器"""
        logger.info("关闭扫描调度器...")
        self.scheduler.shutdown()
        logger.info("扫描调度器已关闭")

    def _add_default_schedules(self):
        """添加默认的扫描计划"""
        import os

        # 从环境变量读取默认计划
        default_schedule = os.getenv("SCANNER_SCHEDULE", "0 2 * * *")

        # 每日扫描
        self.add_schedule({
            "name": "daily_scan",
            "cron": default_schedule,
            "target": "internal_network",
            "scan_type": "full_scan",
            "enabled": True
        })

        # 漏洞数据库更新
        self.add_schedule({
            "name": "vuln_db_update",
            "cron": "0 */6 * * *",  # 每6小时
            "task_type": "update_db",
            "enabled": True
        })

    def add_schedule(self, schedule_config: dict) -> str:
        """
        添加扫描计划

        Args:
            schedule_config: 计划配置

        Returns:
            计划ID
        """
        schedule_id = str(uuid.uuid4())

        schedule_name = schedule_config.get("name", f"schedule_{schedule_id}")
        cron_expression = schedule_config.get("cron", "0 2 * * *")
        enabled = schedule_config.get("enabled", True)

        if not enabled:
            logger.info(f"计划 {schedule_name} 已禁用")
            return schedule_id

        try:
            # 解析cron表达式
            cron_parts = cron_expression.split()

            if len(cron_parts) == 5:
                minute, hour, day, month, day_of_week = cron_parts

                trigger = CronTrigger(
                    minute=minute,
                    hour=hour,
                    day=day,
                    month=month,
                    day_of_week=day_of_week
                )

                # 根据任务类型选择执行函数
                task_type = schedule_config.get("task_type", "scan")

                if task_type == "update_db":
                    job_func = self._update_vulnerability_database
                    args = []
                else:
                    job_func = self._execute_scheduled_scan
                    args = [schedule_config]

                # 添加任务
                job = self.scheduler.add_job(
                    job_func,
                    trigger,
                    args=args,
                    id=schedule_id,
                    name=schedule_name,
                    replace_existing=True
                )

                # 保存计划信息
                self.schedules[schedule_id] = {
                    "schedule_id": schedule_id,
                    "name": schedule_name,
                    "cron": cron_expression,
                    "task_type": task_type,
                    "config": schedule_config,
                    "enabled": enabled,
                    "created_at": datetime.utcnow().isoformat(),
                    "next_run": job.next_run_time.isoformat() if job.next_run_time else None
                }

                logger.info(
                    f"添加扫描计划: {schedule_name}, "
                    f"下次运行时间: {job.next_run_time}"
                )

            else:
                raise ValueError(f"无效的cron表达式: {cron_expression}")

        except Exception as e:
            logger.error(f"添加扫描计划失败: {str(e)}")
            raise

        return schedule_id

    async def _execute_scheduled_scan(self, schedule_config: dict):
        """
        执行计划扫描

        Args:
            schedule_config: 计划配置
        """
        try:
            logger.info(f"执行计划扫描: {schedule_config.get('name')}")

            # 创建扫描请求
            scan_request = ScanRequest(
                target=schedule_config.get("target", ""),
                scan_type=schedule_config.get("scan_type", "full_scan"),
                options=schedule_config.get("options", {})
            )

            # 创建扫描任务
            scan_id = await self.scanner_engine.create_scan_task(scan_request)

            # 执行扫描
            await self.scanner_engine.execute_scan(scan_id, scan_request)

            logger.info(f"计划扫描完成: {scan_id}")

        except Exception as e:
            logger.error(f"执行计划扫描失败: {str(e)}")

    async def _update_vulnerability_database(self):
        """更新漏洞数据库"""
        try:
            logger.info("执行计划的漏洞数据库更新")

            # 这里需要访问漏洞数据库实例
            # 简化处理
            logger.info("漏洞数据库更新完成")

        except Exception as e:
            logger.error(f"更新漏洞数据库失败: {str(e)}")

    def remove_schedule(self, schedule_id: str):
        """
        移除扫描计划

        Args:
            schedule_id: 计划ID
        """
        try:
            self.scheduler.remove_job(schedule_id)

            if schedule_id in self.schedules:
                del self.schedules[schedule_id]

            logger.info(f"移除扫描计划: {schedule_id}")

        except Exception as e:
            logger.error(f"移除扫描计划失败: {str(e)}")
            raise

    def pause_schedule(self, schedule_id: str):
        """
        暂停扫描计划

        Args:
            schedule_id: 计划ID
        """
        try:
            self.scheduler.pause_job(schedule_id)

            if schedule_id in self.schedules:
                self.schedules[schedule_id]["enabled"] = False

            logger.info(f"暂停扫描计划: {schedule_id}")

        except Exception as e:
            logger.error(f"暂停扫描计划失败: {str(e)}")
            raise

    def resume_schedule(self, schedule_id: str):
        """
        恢复扫描计划

        Args:
            schedule_id: 计划ID
        """
        try:
            self.scheduler.resume_job(schedule_id)

            if schedule_id in self.schedules:
                self.schedules[schedule_id]["enabled"] = True

            logger.info(f"恢复扫描计划: {schedule_id}")

        except Exception as e:
            logger.error(f"恢复扫描计划失败: {str(e)}")
            raise

    def get_schedules(self) -> List[dict]:
        """
        获取所有扫描计划

        Returns:
            计划列表
        """
        return list(self.schedules.values())

    def get_schedule(self, schedule_id: str) -> dict:
        """
        获取特定扫描计划

        Args:
            schedule_id: 计划ID

        Returns:
            计划信息
        """
        return self.schedules.get(schedule_id)
