"""
资产发现模块
"""
import asyncio
import nmap
import logging
from typing import List, Dict
from concurrent.futures import ThreadPoolExecutor

logger = logging.getLogger(__name__)


class AssetDiscovery:
    """资产发现类"""

    def __init__(self):
        self.nm = nmap.PortScanner()
        self.executor = ThreadPoolExecutor(max_workers=4)

    async def discover(self, target_range: str) -> List[Dict]:
        """
        发现网络资产

        Args:
            target_range: 目标范围（IP范围或网段）

        Returns:
            资产列表
        """
        logger.info(f"开始资产发现: {target_range}")

        # 主机发现
        hosts = await self.discover_hosts(target_range)

        # 服务指纹识别
        assets = []
        for host in hosts:
            asset_info = await self.fingerprint_host(host)
            assets.append(asset_info)

        logger.info(f"发现 {len(assets)} 个资产")

        return assets

    async def discover_hosts(self, target_range: str) -> List[str]:
        """
        主机发现

        Args:
            target_range: 目标范围

        Returns:
            活跃主机列表
        """
        logger.info(f"执行主机发现: {target_range}")

        loop = asyncio.get_event_loop()
        result = await loop.run_in_executor(
            self.executor,
            self._nmap_ping_scan,
            target_range
        )

        hosts = result.all_hosts()
        logger.info(f"发现 {len(hosts)} 个活跃主机")

        return hosts

    def _nmap_ping_scan(self, target_range: str):
        """执行ping扫描"""
        self.nm.scan(hosts=target_range, arguments='-sn')
        return self.nm

    async def fingerprint_host(self, host: str) -> Dict:
        """
        主机指纹识别

        Args:
            host: 主机地址

        Returns:
            主机详细信息
        """
        logger.info(f"执行指纹识别: {host}")

        loop = asyncio.get_event_loop()
        result = await loop.run_in_executor(
            self.executor,
            self._nmap_fingerprint,
            host
        )

        return self._parse_host_info(result, host)

    def _nmap_fingerprint(self, host: str):
        """执行详细扫描和指纹识别"""
        self.nm.scan(
            hosts=host,
            arguments='-sS -sV -O -A --script=banner'
        )
        return self.nm

    def _parse_host_info(self, nm, host: str) -> Dict:
        """解析主机信息"""
        if host not in nm.all_hosts():
            return {
                "ip": host,
                "status": "down"
            }

        host_data = nm[host]

        asset_info = {
            "ip": host,
            "hostname": host_data.hostname(),
            "status": host_data.state(),
            "mac_address": host_data.get('addresses', {}).get('mac', ''),
            "vendor": host_data.get('vendor', {}),
            "os": self._parse_os_info(host_data),
            "services": self._parse_services(host_data),
            "open_ports": len(host_data.all_tcp()) if 'tcp' in host_data.all_protocols() else 0
        }

        return asset_info

    def _parse_os_info(self, host_data) -> Dict:
        """解析操作系统信息"""
        os_info = {
            "name": "Unknown",
            "family": "Unknown",
            "accuracy": 0
        }

        if 'osmatch' in host_data:
            os_matches = host_data['osmatch']
            if os_matches:
                best_match = os_matches[0]
                os_info = {
                    "name": best_match.get('name', 'Unknown'),
                    "family": best_match.get('osclass', [{}])[0].get('osfamily', 'Unknown') if best_match.get('osclass') else 'Unknown',
                    "accuracy": int(best_match.get('accuracy', 0))
                }

        return os_info

    def _parse_services(self, host_data) -> List[Dict]:
        """解析服务信息"""
        services = []

        for proto in host_data.all_protocols():
            ports = host_data[proto].keys()

            for port in ports:
                port_info = host_data[proto][port]

                service = {
                    "port": port,
                    "protocol": proto,
                    "state": port_info['state'],
                    "service": port_info.get('name', ''),
                    "product": port_info.get('product', ''),
                    "version": port_info.get('version', ''),
                    "extrainfo": port_info.get('extrainfo', ''),
                    "cpe": port_info.get('cpe', '')
                }

                services.append(service)

        return services

    async def discover_web_applications(self, host: str) -> List[Dict]:
        """
        发现Web应用

        Args:
            host: 主机地址

        Returns:
            Web应用列表
        """
        # 扫描常见的Web端口
        web_ports = [80, 443, 8080, 8443, 8000, 3000]

        web_apps = []

        for port in web_ports:
            try:
                # 检查端口是否开放
                # 实际应该使用HTTP客户端检测
                web_apps.append({
                    "host": host,
                    "port": port,
                    "protocol": "https" if port in [443, 8443] else "http",
                    "status": "detected"
                })
            except Exception as e:
                logger.debug(f"端口 {port} 检测失败: {str(e)}")

        return web_apps
