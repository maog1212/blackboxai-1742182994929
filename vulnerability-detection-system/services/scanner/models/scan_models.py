"""
扫描相关数据模型
"""
from pydantic import BaseModel, Field
from typing import Optional, Dict, List
from datetime import datetime


class ScanRequest(BaseModel):
    """扫描请求模型"""
    target: str = Field(..., description="扫描目标（IP、域名或网段）")
    scan_type: str = Field(
        default="port_scan",
        description="扫描类型: port_scan, vulnerability_scan, full_scan"
    )
    options: Dict = Field(default_factory=dict, description="扫描选项")
    priority: str = Field(default="normal", description="优先级: low, normal, high, critical")
    scheduled: bool = Field(default=False, description="是否为计划任务")

    class Config:
        json_schema_extra = {
            "example": {
                "target": "192.168.1.0/24",
                "scan_type": "full_scan",
                "options": {
                    "ports": "1-65535",
                    "aggressive": False
                },
                "priority": "high"
            }
        }


class ScanResponse(BaseModel):
    """扫描响应模型"""
    scan_id: str = Field(..., description="扫描任务ID")
    status: str = Field(..., description="状态: initiated, running, completed, failed")
    message: str = Field(..., description="状态消息")
    created_at: Optional[str] = Field(default=None, description="创建时间")


class VulnerabilityInfo(BaseModel):
    """漏洞信息模型"""
    cve_id: Optional[str] = Field(default=None, description="CVE ID")
    title: str = Field(..., description="漏洞标题")
    description: str = Field(..., description="漏洞描述")
    severity: str = Field(..., description="严重程度: critical, high, medium, low, info")
    cvss_score: float = Field(..., description="CVSS评分")
    cvss_vector: Optional[str] = Field(default=None, description="CVSS向量")
    affected_component: Optional[str] = Field(default=None, description="受影响组件")
    port: Optional[int] = Field(default=None, description="端口")
    service: Optional[str] = Field(default=None, description="服务")
    recommendation: str = Field(..., description="修复建议")
    references: List[str] = Field(default_factory=list, description="参考链接")
    discovered_at: str = Field(..., description="发现时间")

    class Config:
        json_schema_extra = {
            "example": {
                "cve_id": "CVE-2023-12345",
                "title": "Apache HTTP Server 远程代码执行漏洞",
                "description": "Apache HTTP Server 2.4.49存在路径遍历漏洞",
                "severity": "critical",
                "cvss_score": 9.8,
                "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
                "affected_component": "Apache/2.4.49",
                "port": 80,
                "service": "http",
                "recommendation": "升级到Apache 2.4.51或更高版本",
                "references": [
                    "https://httpd.apache.org/security/vulnerabilities_24.html"
                ],
                "discovered_at": "2023-10-01T10:00:00Z"
            }
        }


class AssetInfo(BaseModel):
    """资产信息模型"""
    ip: str = Field(..., description="IP地址")
    hostname: Optional[str] = Field(default=None, description="主机名")
    mac_address: Optional[str] = Field(default=None, description="MAC地址")
    os: Optional[Dict] = Field(default=None, description="操作系统信息")
    open_ports: int = Field(default=0, description="开放端口数量")
    services: List[Dict] = Field(default_factory=list, description="运行的服务")
    status: str = Field(..., description="状态: up, down, unknown")
    last_seen: str = Field(..., description="最后发现时间")

    class Config:
        json_schema_extra = {
            "example": {
                "ip": "192.168.1.100",
                "hostname": "web-server-01",
                "mac_address": "00:11:22:33:44:55",
                "os": {
                    "name": "Linux 5.15",
                    "family": "Linux",
                    "accuracy": 95
                },
                "open_ports": 3,
                "services": [
                    {
                        "port": 22,
                        "protocol": "tcp",
                        "service": "ssh",
                        "product": "OpenSSH",
                        "version": "8.2"
                    }
                ],
                "status": "up",
                "last_seen": "2023-10-01T10:00:00Z"
            }
        }


class ScanResult(BaseModel):
    """扫描结果模型"""
    scan_id: str = Field(..., description="扫描任务ID")
    target: str = Field(..., description="扫描目标")
    scan_type: str = Field(..., description="扫描类型")
    status: str = Field(..., description="状态")
    started_at: str = Field(..., description="开始时间")
    completed_at: Optional[str] = Field(default=None, description="完成时间")
    duration: Optional[float] = Field(default=None, description="扫描耗时（秒）")
    hosts_scanned: int = Field(default=0, description="扫描的主机数")
    vulnerabilities_found: int = Field(default=0, description="发现的漏洞数")
    vulnerabilities: List[VulnerabilityInfo] = Field(default_factory=list, description="漏洞列表")
    summary: Optional[Dict] = Field(default=None, description="扫描摘要")

    class Config:
        json_schema_extra = {
            "example": {
                "scan_id": "123e4567-e89b-12d3-a456-426614174000",
                "target": "192.168.1.0/24",
                "scan_type": "full_scan",
                "status": "completed",
                "started_at": "2023-10-01T10:00:00Z",
                "completed_at": "2023-10-01T11:00:00Z",
                "duration": 3600,
                "hosts_scanned": 254,
                "vulnerabilities_found": 15,
                "vulnerabilities": [],
                "summary": {
                    "critical": 2,
                    "high": 5,
                    "medium": 6,
                    "low": 2,
                    "info": 0
                }
            }
        }
