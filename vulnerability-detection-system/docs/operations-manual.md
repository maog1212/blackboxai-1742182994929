# 操作手册

## 目录

1. [系统概述](#系统概述)
2. [安装部署](#安装部署)
3. [日常运维](#日常运维)
4. [监控告警](#监控告警)
5. [故障排查](#故障排查)
6. [安全最佳实践](#安全最佳实践)
7. [备份恢复](#备份恢复)

---

## 系统概述

### 架构说明

漏洞检测系统采用微服务架构，包含以下核心组件:

- **API Gateway**: 统一入口，负责认证和请求路由
- **Scanner Service**: 漏洞扫描服务
- **Detection Engine**: 实时检测引擎
- **Response Service**: 响应和修复服务
- **Notification Service**: 通知和报告服务

### 系统要求

**硬件要求:**
- CPU: 4核心或以上
- 内存: 8GB或以上
- 存储: 50GB或以上

**软件要求:**
- Docker 20.10+
- Docker Compose 2.0+
- Kubernetes 1.24+ (K8s部署)
- PostgreSQL 15
- Redis 7
- RabbitMQ 3

---

## 安装部署

### 本地开发环境

#### 1. 克隆代码

```bash
git clone <repository-url>
cd vulnerability-detection-system
```

#### 2. 配置环境变量

```bash
cp .env.example .env
# 编辑.env文件，配置必要参数
vim .env
```

**必须配置的参数:**
- `DATABASE_URL`: 数据库连接字符串
- `JWT_SECRET`: JWT密钥（生产环境必须修改）
- `SMTP_*`: 邮件服务器配置
- `SLACK_WEBHOOK`: Slack通知地址（可选）

#### 3. 启动服务

```bash
chmod +x scripts/deploy-local.sh
./scripts/deploy-local.sh
```

#### 4. 验证部署

访问以下地址验证服务:
- API Gateway: http://localhost:8080/health
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000

### Kubernetes生产环境

#### 1. 准备集群

确保Kubernetes集群已就绪:
```bash
kubectl cluster-info
kubectl get nodes
```

#### 2. 修改配置

编辑Kubernetes配置文件:
```bash
# 修改Secrets（重要！）
vim deployment/kubernetes/secrets.yaml

# 根据需要修改ConfigMap
vim deployment/kubernetes/configmap.yaml
```

#### 3. 执行部署

```bash
chmod +x scripts/deploy-k8s.sh
./scripts/deploy-k8s.sh
```

#### 4. 验证部署

```bash
# 查看所有Pods
kubectl get pods -n vuln-detection

# 查看服务
kubectl get services -n vuln-detection

# 查看日志
kubectl logs -f -l app=api-gateway -n vuln-detection
```

---

## 日常运维

### 服务管理

#### Docker Compose环境

**查看服务状态:**
```bash
docker-compose ps
```

**查看日志:**
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务
docker-compose logs -f scanner
```

**重启服务:**
```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart scanner
```

**停止服务:**
```bash
docker-compose down
```

#### Kubernetes环境

**查看Pod状态:**
```bash
kubectl get pods -n vuln-detection
```

**查看日志:**
```bash
# 查看特定Pod
kubectl logs <pod-name> -n vuln-detection

# 实时查看
kubectl logs -f <pod-name> -n vuln-detection

# 查看之前崩溃的容器
kubectl logs <pod-name> -n vuln-detection --previous
```

**重启Pod:**
```bash
kubectl rollout restart deployment/<deployment-name> -n vuln-detection
```

**扩缩容:**
```bash
# 扩展副本数
kubectl scale deployment scanner --replicas=3 -n vuln-detection
```

### 数据库维护

#### 备份数据库

```bash
# Docker环境
docker-compose exec postgres pg_dump -U vulnuser vulndb > backup_$(date +%Y%m%d).sql

# Kubernetes环境
kubectl exec -n vuln-detection <postgres-pod> -- pg_dump -U vulnuser vulndb > backup_$(date +%Y%m%d).sql
```

#### 恢复数据库

```bash
# Docker环境
docker-compose exec -T postgres psql -U vulnuser vulndb < backup.sql

# Kubernetes环境
kubectl exec -i -n vuln-detection <postgres-pod> -- psql -U vulnuser vulndb < backup.sql
```

#### 清理旧数据

```sql
-- 清理90天前的扫描记录
DELETE FROM scan_tasks WHERE created_at < NOW() - INTERVAL '90 days';

-- 清理已解决的漏洞记录（180天前）
DELETE FROM vulnerabilities
WHERE status = 'resolved'
AND resolved_at < NOW() - INTERVAL '180 days';

-- 清理旧的通知记录
DELETE FROM notifications
WHERE created_at < NOW() - INTERVAL '30 days';
```

### 更新漏洞数据库

```bash
# 通过API触发更新
curl -X POST http://localhost:8080/api/v1/update-vulnerability-db \
  -H "Authorization: Bearer <token>"
```

### 配置扫描计划

```bash
# 创建定期扫描计划
curl -X POST http://localhost:8080/api/v1/schedules \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "weekly_scan",
    "cron": "0 2 * * 0",
    "target": "192.168.1.0/24",
    "scan_type": "full_scan",
    "enabled": true
  }'
```

---

## 监控告警

### Prometheus监控

访问Prometheus: http://localhost:9090

**常用查询:**

```promql
# API请求速率
rate(api_requests_total[5m])

# 扫描任务成功率
rate(vulnerability_scans_total{status="success"}[1h]) /
rate(vulnerability_scans_total[1h])

# 发现的漏洞数量
sum by (severity) (vulnerabilities_found_total)

# 服务可用性
up{job=~"scanner|detection|response|notification"}
```

### Grafana仪表板

访问Grafana: http://localhost:3000
- 默认用户名: admin
- 默认密码: admin_password

**推荐的仪表板:**
1. 系统概览
2. 扫描统计
3. 漏洞趋势
4. 服务性能

### 告警规则

在`deployment/docker/prometheus.yml`中配置告警规则:

```yaml
groups:
  - name: vulnerability_alerts
    rules:
      - alert: HighCriticalVulnerabilities
        expr: vulnerabilities_found_total{severity="critical"} > 10
        for: 5m
        annotations:
          summary: "发现大量Critical漏洞"
          description: "在过去5分钟内发现了{{ $value }}个Critical级别漏洞"

      - alert: ScannerServiceDown
        expr: up{job="scanner"} == 0
        for: 1m
        annotations:
          summary: "扫描服务不可用"
          description: "Scanner服务已停止响应"
```

### 日志管理

#### 查看日志

**Docker环境:**
```bash
docker-compose logs -f --tail=100 scanner
```

**Kubernetes环境:**
```bash
kubectl logs -f --tail=100 -l app=scanner -n vuln-detection
```

#### ELK日志分析

访问Kibana: http://localhost:5601

1. 配置索引模式: `logstash-*`
2. 使用KQL查询日志:
   ```
   service.name: "scanner" AND level: "error"
   ```

---

## 故障排查

### 常见问题

#### 1. 服务无法启动

**症状:** 容器反复重启

**排查步骤:**
```bash
# 查看Pod事件
kubectl describe pod <pod-name> -n vuln-detection

# 查看容器日志
kubectl logs <pod-name> -n vuln-detection

# 检查资源限制
kubectl top pods -n vuln-detection
```

**常见原因:**
- 数据库连接失败
- 内存不足
- 配置错误

#### 2. 扫描任务失败

**症状:** 扫描状态显示为failed

**排查:**
```bash
# 查看扫描任务详情
curl http://localhost:8080/api/v1/scan/<scan_id> \
  -H "Authorization: Bearer <token>"

# 查看Scanner服务日志
kubectl logs -l app=scanner -n vuln-detection --tail=100
```

**可能原因:**
- 目标不可达
- 扫描超时
- 权限不足

#### 3. 数据库性能问题

**症状:** 查询缓慢

**优化:**
```sql
-- 重建索引
REINDEX DATABASE vulndb;

-- 分析表
ANALYZE vulnerabilities;

-- 清理无用数据
VACUUM FULL;
```

#### 4. 内存溢出

**症状:** Pod被OOMKilled

**解决:**
```bash
# 增加内存限制
kubectl edit deployment scanner -n vuln-detection

# 修改resources.limits.memory
resources:
  limits:
    memory: "4Gi"  # 增加到4GB
```

### 诊断工具

#### 健康检查

```bash
# 检查所有服务健康状态
for service in api-gateway scanner detection-engine response notification; do
  echo "Checking $service..."
  curl -f http://localhost:808{0..4}/health || echo "Failed"
done
```

#### 网络诊断

```bash
# 测试服务间连通性
kubectl exec -it <api-gateway-pod> -n vuln-detection -- curl http://scanner:8081/health

# 检查DNS解析
kubectl exec -it <pod-name> -n vuln-detection -- nslookup scanner
```

#### 性能分析

```bash
# CPU和内存使用
kubectl top pods -n vuln-detection

# 查看资源配额
kubectl describe resourcequota -n vuln-detection
```

---

## 安全最佳实践

### 1. 密钥管理

- 使用强密码和密钥
- 定期轮换密钥
- 使用Kubernetes Secrets或Vault管理敏感信息
- 不要在代码或配置文件中硬编码密钥

### 2. 网络安全

- 使用TLS加密所有通信
- 限制服务只暴露必要的端口
- 配置网络策略限制Pod间通信
- 使用防火墙规则保护数据库

### 3. 访问控制

- 启用RBAC
- 实施最小权限原则
- 定期审查用户权限
- 启用审计日志

### 4. 容器安全

- 使用非root用户运行容器
- 定期更新基础镜像
- 扫描镜像漏洞
- 限制容器权限

### 5. 数据保护

- 启用数据库加密
- 定期备份
- 加密敏感数据
- 实施数据保留策略

---

## 备份恢复

### 完整备份

```bash
#!/bin/bash
BACKUP_DIR="/backup/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 备份数据库
kubectl exec -n vuln-detection <postgres-pod> -- \
  pg_dump -U vulnuser vulndb | gzip > $BACKUP_DIR/database.sql.gz

# 备份配置
kubectl get configmap,secret -n vuln-detection -o yaml > $BACKUP_DIR/configs.yaml

# 备份PV数据
kubectl exec -n vuln-detection <scanner-pod> -- \
  tar -czf - /var/lib/scanner > $BACKUP_DIR/scanner-data.tar.gz
```

### 恢复流程

```bash
# 1. 停止服务
kubectl scale deployment --all --replicas=0 -n vuln-detection

# 2. 恢复数据库
gunzip < database.sql.gz | kubectl exec -i -n vuln-detection <postgres-pod> -- \
  psql -U vulnuser vulndb

# 3. 恢复配置
kubectl apply -f configs.yaml

# 4. 重启服务
kubectl scale deployment --all --replicas=2 -n vuln-detection
```

### 灾难恢复

1. 准备新的Kubernetes集群
2. 恢复配置文件
3. 恢复数据库备份
4. 部署服务
5. 验证功能

---

## 性能优化

### 数据库优化

```sql
-- 增加连接池大小
ALTER SYSTEM SET max_connections = 200;

-- 优化查询性能
ALTER SYSTEM SET shared_buffers = '2GB';
ALTER SYSTEM SET effective_cache_size = '6GB';
```

### 服务优化

```yaml
# 增加worker数量
environment:
  - UVICORN_WORKERS=4

# 启用缓存
environment:
  - CACHE_ENABLED=true
  - CACHE_TTL=300
```

### 扫描优化

```bash
# 调整并发扫描数
SCAN_THREADS=8
MAX_CONCURRENT_SCANS=20
```

---

## 维护窗口

### 计划停机

```bash
# 1. 通知用户
# 2. 停止接受新请求
kubectl scale deployment api-gateway --replicas=0 -n vuln-detection

# 3. 等待现有任务完成
# 4. 执行维护
# 5. 重启服务
kubectl scale deployment api-gateway --replicas=2 -n vuln-detection
```

### 滚动更新

```bash
# 更新镜像
kubectl set image deployment/scanner \
  scanner=vuln-detection/scanner:v1.1.0 \
  -n vuln-detection

# 监控更新过程
kubectl rollout status deployment/scanner -n vuln-detection

# 回滚（如需要）
kubectl rollout undo deployment/scanner -n vuln-detection
```

---

## 联系支持

如遇到无法解决的问题:

1. 收集诊断信息
2. 查看错误日志
3. 记录复现步骤
4. 联系技术支持团队

**支持渠道:**
- Email: support@example.com
- Issue: GitHub Issues
- 文档: https://docs.example.com
