# API文档

## 概述

漏洞检测系统提供RESTful API，支持漏洞扫描、检测、修复和通知等功能。

**Base URL:** `http://your-domain:8080/api/v1`

## 认证

所有API请求（除了登录接口）都需要JWT认证。

### 登录

```http
POST /auth/login
```

**请求体:**
```json
{
  "username": "admin",
  "password": "admin"
}
```

**响应:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### 使用Token

在请求头中添加:
```
Authorization: Bearer <token>
```

---

## 扫描服务 API

### 1. 启动扫描

启动一个新的漏洞扫描任务。

```http
POST /api/v1/scan
```

**请求体:**
```json
{
  "target": "192.168.1.0/24",
  "scan_type": "full_scan",
  "options": {
    "ports": "1-65535",
    "aggressive": false
  },
  "priority": "high"
}
```

**参数说明:**
- `target`: 扫描目标（IP、域名或网段）
- `scan_type`: 扫描类型
  - `port_scan`: 端口扫描
  - `vulnerability_scan`: 漏洞扫描
  - `full_scan`: 完整扫描
- `options`: 扫描选项
  - `ports`: 端口范围
  - `aggressive`: 是否使用激进模式
- `priority`: 优先级 (low, normal, high, critical)

**响应:**
```json
{
  "scan_id": "123e4567-e89b-12d3-a456-426614174000",
  "status": "initiated",
  "message": "扫描任务已创建"
}
```

### 2. 获取扫描状态

```http
GET /api/v1/scan/{scan_id}
```

**响应:**
```json
{
  "scan_id": "123e4567-e89b-12d3-a456-426614174000",
  "target": "192.168.1.0/24",
  "scan_type": "full_scan",
  "status": "running",
  "created_at": "2023-10-01T10:00:00Z",
  "updated_at": "2023-10-01T10:30:00Z"
}
```

**状态值:**
- `pending`: 等待中
- `running`: 运行中
- `completed`: 已完成
- `failed`: 失败

### 3. 获取扫描结果

```http
GET /api/v1/scan/{scan_id}/results
```

**响应:**
```json
{
  "scan_id": "123e4567-e89b-12d3-a456-426614174000",
  "hosts_scanned": 254,
  "vulnerabilities_found": 15,
  "summary": {
    "critical": 2,
    "high": 5,
    "medium": 6,
    "low": 2
  },
  "vulnerabilities": [
    {
      "cve_id": "CVE-2023-12345",
      "title": "Apache HTTP Server 远程代码执行",
      "severity": "critical",
      "cvss_score": 9.8,
      "affected_component": "Apache/2.4.49",
      "port": 80,
      "recommendation": "升级到Apache 2.4.51或更高版本"
    }
  ]
}
```

### 4. 资产发现

```http
POST /api/v1/discover-assets
```

**请求体:**
```json
{
  "target_range": "192.168.1.0/24"
}
```

**响应:**
```json
{
  "discovered_assets": 45,
  "assets": [
    {
      "ip": "192.168.1.100",
      "hostname": "web-server-01",
      "os": {
        "name": "Linux 5.15",
        "family": "Linux"
      },
      "open_ports": 3,
      "services": [
        {
          "port": 22,
          "service": "ssh",
          "version": "OpenSSH 8.2"
        }
      ]
    }
  ]
}
```

---

## 检测引擎 API

### 1. 文件完整性检查

```http
POST /api/v1/detect/file-integrity
```

**请求体:**
```json
{
  "file_path": "/etc/passwd"
}
```

**响应:**
```json
{
  "status": "ok"
}
```

或发现异常时:
```json
{
  "type": "file_modified",
  "file": "/etc/passwd",
  "old_hash": "abc123...",
  "new_hash": "def456...",
  "severity": "high"
}
```

### 2. 日志异常检测

```http
POST /api/v1/detect/log-anomaly
```

**请求体:**
```json
{
  "log_entry": "Failed login attempt from 192.168.1.100"
}
```

**响应:**
```json
{
  "detections": [
    {
      "type": "authentication_failure",
      "log": "Failed login attempt from 192.168.1.100",
      "severity": "medium"
    }
  ],
  "count": 1
}
```

### 3. 列出检测规则

```http
GET /api/v1/rules
```

**响应:**
```json
{
  "rules": [
    "rule_sql_injection",
    "rule_xss_attack",
    "rule_path_traversal"
  ],
  "count": 3
}
```

---

## 响应服务 API

### 1. 创建修复计划

```http
POST /api/v1/remediation/plan
```

**请求体:**
```json
{
  "vuln_id": "vuln-001",
  "cve_id": "CVE-2023-12345",
  "severity": "critical",
  "affected_component": "Apache/2.4.49",
  "version": "2.4.49"
}
```

**响应:**
```json
{
  "vuln_id": "vuln-001",
  "steps": [
    {
      "order": 1,
      "action": "backup_current_version",
      "description": "备份当前Apache配置和数据",
      "command": "tar -czf /backup/apache.tar.gz /etc/apache2"
    },
    {
      "order": 2,
      "action": "update_package",
      "description": "更新Apache到最新版本",
      "command": "apt-get install --only-upgrade apache2"
    }
  ],
  "estimated_time": 15,
  "risk_level": "high",
  "requires_confirmation": true
}
```

### 2. 执行修复

```http
POST /api/v1/remediation/execute
```

**请求体:**
```json
{
  "vuln_id": "vuln-001",
  "steps": [...],
  "confirmed": true
}
```

**响应:**
```json
{
  "status": "completed",
  "vuln_id": "vuln-001",
  "results": [
    {
      "step": 1,
      "action": "backup_current_version",
      "status": "success"
    }
  ]
}
```

### 3. 验证修复

```http
POST /api/v1/remediation/verify
```

**请求体:**
```json
{
  "vuln_id": "vuln-001",
  "cve_id": "CVE-2023-12345"
}
```

**响应:**
```json
{
  "vuln_id": "vuln-001",
  "verified": true,
  "status": "fixed",
  "message": "漏洞已修复"
}
```

---

## 通知服务 API

### 1. 发送通知

```http
POST /api/v1/notify
```

**请求体:**
```json
{
  "type": "email",
  "recipients": ["admin@example.com"],
  "subject": "Critical Vulnerability Alert",
  "message": "发现严重漏洞CVE-2023-12345",
  "severity": "critical",
  "data": {
    "cve_id": "CVE-2023-12345",
    "affected_systems": 5
  }
}
```

**通知类型:**
- `email`: 邮件通知
- `slack`: Slack通知
- `webhook`: Webhook通知
- `all`: 所有类型

**响应:**
```json
{
  "status": "success",
  "results": [
    {
      "status": "sent",
      "recipients": ["admin@example.com"]
    }
  ]
}
```

### 2. 生成报告

```http
POST /api/v1/report
```

**请求体:**
```json
{
  "report_type": "vulnerability",
  "format": "json",
  "start_date": "2023-10-01",
  "end_date": "2023-10-31"
}
```

**报告类型:**
- `vulnerability`: 漏洞报告
- `compliance`: 合规报告
- `trend`: 趋势分析报告

**格式:**
- `json`: JSON格式
- `html`: HTML格式
- `pdf`: PDF格式

**响应:**
```json
{
  "title": "漏洞扫描报告",
  "generated_at": "2023-11-01T10:00:00Z",
  "period": {
    "start": "2023-10-01",
    "end": "2023-10-31"
  },
  "summary": {
    "total_vulnerabilities": 156,
    "critical": 12,
    "high": 34,
    "medium": 67,
    "low": 43
  }
}
```

---

## 系统管理 API

### 获取服务状态

```http
GET /api/v1/services/status
```

**响应:**
```json
{
  "services": {
    "scanner": {
      "status": "healthy",
      "version": "1.0.0"
    },
    "detection": {
      "status": "healthy",
      "version": "1.0.0"
    },
    "response": {
      "status": "healthy",
      "version": "1.0.0"
    },
    "notification": {
      "status": "healthy",
      "version": "1.0.0"
    }
  }
}
```

---

## 错误代码

| 代码 | 说明 |
|-----|------|
| 200 | 成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |
| 502 | 网关错误 |
| 503 | 服务不可用 |

**错误响应格式:**
```json
{
  "detail": "错误描述信息"
}
```

---

## 速率限制

- 默认限制: 100请求/分钟
- 扫描API: 10请求/分钟
- 修复API: 20请求/分钟

超过限制时返回:
```json
{
  "detail": "Rate limit exceeded"
}
```

---

## 示例代码

### Python

```python
import requests

# 登录
response = requests.post(
    "http://localhost:8080/auth/login",
    json={"username": "admin", "password": "admin"}
)
token = response.json()["access_token"]

# 启动扫描
headers = {"Authorization": f"Bearer {token}"}
response = requests.post(
    "http://localhost:8080/api/v1/scan",
    headers=headers,
    json={
        "target": "192.168.1.0/24",
        "scan_type": "full_scan"
    }
)
scan_id = response.json()["scan_id"]

# 获取结果
response = requests.get(
    f"http://localhost:8080/api/v1/scan/{scan_id}/results",
    headers=headers
)
results = response.json()
```

### cURL

```bash
# 登录
TOKEN=$(curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin"}' \
  | jq -r '.access_token')

# 启动扫描
curl -X POST http://localhost:8080/api/v1/scan \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "target": "192.168.1.0/24",
    "scan_type": "full_scan"
  }'
```

---

## 支持

如有问题，请查阅操作手册或联系技术支持团队。
