#!/bin/bash

# Kubernetes部署脚本

set -e

echo "======================================"
echo "漏洞检测系统 - Kubernetes部署"
echo "======================================"

# 检查kubectl
if ! command -v kubectl &> /dev/null; then
    echo "错误: kubectl未安装"
    exit 1
fi

# 设置变量
NAMESPACE="vuln-detection"
K8S_DIR="deployment/kubernetes"

# 创建命名空间
echo ""
echo "步骤 1/6: 创建命名空间..."
kubectl apply -f $K8S_DIR/namespace.yaml

# 创建ConfigMap和Secrets
echo ""
echo "步骤 2/6: 创建ConfigMap和Secrets..."
echo "警告: 请确保已修改secrets.yaml中的敏感信息！"
read -p "继续? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "部署已取消"
    exit 1
fi

kubectl apply -f $K8S_DIR/configmap.yaml
kubectl apply -f $K8S_DIR/secrets.yaml

# 创建PersistentVolumeClaims
echo ""
echo "步骤 3/6: 创建存储卷..."
kubectl apply -f $K8S_DIR/pvc.yaml

# 等待PVC就绪
echo "等待PVC就绪..."
kubectl wait --for=condition=Bound pvc/postgres-pvc -n $NAMESPACE --timeout=60s

# 部署基础设施服务
echo ""
echo "步骤 4/6: 部署基础设施服务..."
kubectl apply -f $K8S_DIR/deployments.yaml
kubectl apply -f $K8S_DIR/services.yaml

# 等待Pods就绪
echo ""
echo "步骤 5/6: 等待Pods就绪..."
kubectl wait --for=condition=Ready pod -l app=postgres -n $NAMESPACE --timeout=120s
kubectl wait --for=condition=Ready pod -l app=redis -n $NAMESPACE --timeout=120s
kubectl wait --for=condition=Ready pod -l app=rabbitmq -n $NAMESPACE --timeout=120s

echo "等待应用服务启动..."
sleep 30

kubectl wait --for=condition=Ready pod -l app=api-gateway -n $NAMESPACE --timeout=120s || echo "API Gateway启动中..."
kubectl wait --for=condition=Ready pod -l app=scanner -n $NAMESPACE --timeout=120s || echo "Scanner启动中..."

# 显示部署状态
echo ""
echo "步骤 6/6: 检查部署状态..."
echo ""
echo "======================================"
echo "Pods状态"
echo "======================================"
kubectl get pods -n $NAMESPACE

echo ""
echo "======================================"
echo "Services状态"
echo "======================================"
kubectl get services -n $NAMESPACE

# 获取API Gateway访问地址
echo ""
echo "======================================"
echo "部署完成!"
echo "======================================"
echo ""

API_GATEWAY_IP=$(kubectl get service api-gateway -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
if [ -z "$API_GATEWAY_IP" ]; then
    API_GATEWAY_IP=$(kubectl get service api-gateway -n $NAMESPACE -o jsonpath='{.spec.clusterIP}')
    echo "API Gateway地址: http://$API_GATEWAY_IP:8080 (ClusterIP)"
    echo ""
    echo "要从集群外访问，运行:"
    echo "  kubectl port-forward -n $NAMESPACE service/api-gateway 8080:8080"
else
    echo "API Gateway地址: http://$API_GATEWAY_IP:8080"
fi

echo ""
echo "有用的命令:"
echo "  查看所有资源: kubectl get all -n $NAMESPACE"
echo "  查看日志: kubectl logs -f -l app=<service-name> -n $NAMESPACE"
echo "  删除部署: kubectl delete namespace $NAMESPACE"
echo ""
