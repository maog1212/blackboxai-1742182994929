#!/bin/bash

# 本地Docker Compose部署脚本

set -e

echo "======================================"
echo "漏洞检测系统 - 本地部署"
echo "======================================"

# 检查Docker和Docker Compose
if ! command -v docker &> /dev/null; then
    echo "错误: Docker未安装"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "错误: Docker Compose未安装"
    exit 1
fi

# 检查环境变量文件
if [ ! -f ".env" ]; then
    echo "未找到.env文件，从.env.example复制..."
    cp .env.example .env
    echo "请编辑.env文件配置必要的参数"
    exit 1
fi

# 构建镜像
echo ""
echo "步骤 1/4: 构建Docker镜像..."
docker-compose build

# 创建网络
echo ""
echo "步骤 2/4: 创建Docker网络..."
docker network create vuln-network 2>/dev/null || echo "网络已存在"

# 启动基础设施服务
echo ""
echo "步骤 3/4: 启动基础设施服务..."
docker-compose up -d postgres redis rabbitmq

echo "等待数据库就绪..."
sleep 10

# 初始化数据库
echo ""
echo "初始化数据库..."
docker-compose exec -T postgres psql -U vulnuser -d vulndb < database/schemas/init.sql 2>/dev/null || echo "数据库已初始化"

# 启动所有服务
echo ""
echo "步骤 4/4: 启动所有服务..."
docker-compose up -d

# 等待服务启动
echo ""
echo "等待服务启动..."
sleep 15

# 检查服务状态
echo ""
echo "======================================"
echo "服务状态检查"
echo "======================================"

services=("api-gateway:8080" "scanner:8081" "detection-engine:8082" "response:8083" "notification:8084")

for service in "${services[@]}"; do
    IFS=':' read -r name port <<< "$service"
    if curl -f http://localhost:$port/health &> /dev/null; then
        echo "✓ $name - 运行中"
    else
        echo "✗ $name - 未就绪"
    fi
done

echo ""
echo "======================================"
echo "部署完成!"
echo "======================================"
echo ""
echo "服务访问地址:"
echo "  API Gateway:    http://localhost:8080"
echo "  Prometheus:     http://localhost:9090"
echo "  Grafana:        http://localhost:3000"
echo "  Kibana:         http://localhost:5601"
echo "  RabbitMQ UI:    http://localhost:15672"
echo ""
echo "查看日志: docker-compose logs -f [service-name]"
echo "停止服务: docker-compose down"
echo ""
